---
phase: 03-self-evolution-engine
plan: 06
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - shared/modules/drafts.py
  - shared/modules/versioning.py
  - shared/modules/audit.py
  - orchestrator/admin_api.py
  - tests/integration/dev_mode/test_draft_diff_validate_promote.py
  - tests/integration/dev_mode/test_rollback_pointer.py
autonomous: false
user_setup:
  - "Define roles for dev-mode actions (operator vs admin) if auth boundary is already in progress"

must_haves:
  truths:
    - "Drafts are editable but never installable until re-validated and promoted"
    - "Promotion creates a new immutable validated version (new bundle_sha256 + attestation)"
    - "Rollback is pointer movement to a prior validated version (no rebuild required)"
    - "All actions are audited (edit/validate/promote/install/rollback) with hashes and actor identity"
    - "Dev-mode does not bypass the install attestation guard from Plan 03-04"
    - "Draft creation from installed module preserves original version reference"
  artifacts:
    - path: "shared/modules/drafts.py"
      provides: "Draft lifecycle management (create, edit, diff, promote)"
      contains: "DraftManager, DraftState"
    - path: "shared/modules/versioning.py"
      provides: "Version pointer management for rollback"
      contains: "VersionManager, rollback_to_version"
    - path: "shared/modules/audit.py"
      provides: "Full audit trail for dev-mode actions"
      contains: "AuditEvent, DevModeAuditLog"
    - path: "orchestrator/admin_api.py"
      provides: "Admin endpoints for draft/promote/rollback operations"
      contains: "draft_module, promote_draft, rollback_module"
  key_links:
    - from: "shared/modules/drafts.py"
      to: "tools/builtin/module_validator.py"
      via: "draft promotion requires re-validation in sandbox"
      pattern: "validate_module"
    - from: "shared/modules/drafts.py"
      to: "tools/builtin/module_installer.py"
      via: "promoted draft installs via same attestation guard"
      pattern: "install_module"
    - from: "shared/modules/versioning.py"
      to: "shared/modules/registry.py"
      via: "rollback updates active version pointer in registry"
      pattern: "set_active_version"
    - from: "orchestrator/admin_api.py"
      to: "shared/modules/drafts.py"
      via: "admin endpoints delegate to draft manager"
      pattern: "DraftManager"
---

<objective>
Allow safe human edits without breaking supply-chain guarantees: drafts, diffs, re-validation, promotion, rollback, audit.

Purpose: Enable developers to inspect, modify, and iterate on generated modules while maintaining the same validation and attestation guarantees as the automated pipeline.
Output: Full draft-to-production lifecycle with auditable actions and rollback safety.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/03-self-evolution-engine/03-RESEARCH.md
@tools/builtin/module_installer.py
@tools/builtin/module_validator.py
@shared/modules/registry.py
@shared/modules/audit.py
@shared/auth/rbac.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Draft lifecycle management</name>
  <files>shared/modules/drafts.py, shared/modules/audit.py</files>
  <action>
Implement draft system:

DraftState enum: CREATED, EDITING, VALIDATING, VALIDATED, PROMOTED, DISCARDED

DraftManager:
- create_draft(module_id, from_version): copy installed module files into draft workspace, record source version
- edit_file(draft_id, file_path, content): update file in draft, record edit action in audit
- get_diff(draft_id): produce unified diff between draft and source version
- discard_draft(draft_id): mark as DISCARDED, preserve for audit

Constraints:
- Draft is never installable directly — must go through promote flow
- Draft workspace is isolated from installed module directory
- Multiple drafts per module are allowed but only one can be promoted at a time

Audit: every action (create, edit, diff_view, discard) logged with actor, timestamp, file hashes.
  </action>
  <verify>
Run: `cd /Users/sertanavdan/Documents/Software/AI/gRPC_llm && python -c "from shared.modules.drafts import DraftManager; print('drafts import ok')"`
  </verify>
  <done>
Draft lifecycle is functional. Drafts are editable, diffable, and never directly installable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Revalidation + promotion</name>
  <files>shared/modules/drafts.py, shared/modules/audit.py, tests/integration/dev_mode/test_draft_diff_validate_promote.py</files>
  <action>
Implement promotion flow:

validate_draft(draft_id):
- Run draft files through module_validator.py (same sandbox validation as automated pipeline)
- Store validation report as artifact with new bundle_sha256
- Update draft state to VALIDATED or FAILED

promote_draft(draft_id):
- Pre-condition: draft state must be VALIDATED
- Create new immutable version with new bundle_sha256 + attestation
- Install via module_installer.py (same attestation guard — no bypass)
- Update draft state to PROMOTED
- Record promotion in audit with actor + bundle_sha256

Add integration test:
- Create draft from installed module
- Edit a file (fix a mapping bug)
- View diff
- Validate in sandbox
- Promote to new validated version
- Verify installed module reflects changes
- Verify original version is still available
  </action>
  <verify>
Run: `cd /Users/sertanavdan/Documents/Software/AI/gRPC_llm && python -m pytest tests/integration/dev_mode/test_draft_diff_validate_promote.py -v --tb=short`
  </verify>
  <done>
Promotion creates a new immutable validated version. Draft must pass sandbox validation before promotion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Rollback + version pointer management</name>
  <files>shared/modules/versioning.py, shared/modules/registry.py, tests/integration/dev_mode/test_rollback_pointer.py</files>
  <action>
Implement version pointer system:

VersionManager:
- list_versions(module_id): return all validated versions with timestamps and bundle hashes
- get_active_version(module_id): return currently installed version
- rollback_to_version(module_id, target_version): move active pointer to prior validated version
- No rebuild: rollback is instant pointer movement, not re-generation

Constraints:
- Can only rollback to a version with status VALIDATED
- Rollback creates audit record with: actor, from_version, to_version, reason
- Rolled-back-from version is not deleted — remains available for future rollback

Add integration test:
- Install v1 (generated), promote v2 (dev-mode edit), rollback to v1
- Verify active module is v1 behavior
- Verify v2 is still available for re-activation
  </action>
  <verify>
Run: `cd /Users/sertanavdan/Documents/Software/AI/gRPC_llm && python -m pytest tests/integration/dev_mode/test_rollback_pointer.py -v --tb=short`
  </verify>
  <done>
Rollback is pointer movement to a prior validated version. No rebuild required. All versions preserved.
  </done>
</task>

<task type="auto">
  <name>Task 4: Admin API endpoints + RBAC</name>
  <files>orchestrator/admin_api.py</files>
  <action>
Add admin endpoints for dev-mode operations:

POST /admin/modules/{module_id}/draft — create draft from installed module
PATCH /admin/modules/drafts/{draft_id} — edit file in draft
GET /admin/modules/drafts/{draft_id}/diff — view diff
POST /admin/modules/drafts/{draft_id}/validate — trigger sandbox validation
POST /admin/modules/drafts/{draft_id}/promote — promote to new version
DELETE /admin/modules/drafts/{draft_id} — discard draft
POST /admin/modules/{module_id}/rollback — rollback to prior version
GET /admin/modules/{module_id}/versions — list all validated versions

RBAC enforcement (using existing shared/auth/rbac.py):
- Draft create/edit/diff: operator+ role
- Validate/promote/rollback: admin+ role
- Version listing: viewer+ role

All endpoints return structured JSON with audit references.
  </action>
  <verify>
Run: `cd /Users/sertanavdan/Documents/Software/AI/gRPC_llm && python -c "from orchestrator.admin_api import app; print('admin_api import ok')"`
  </verify>
  <done>
Dev-mode admin endpoints are functional with RBAC enforcement. All operations are auditable.
  </done>
</task>

</tasks>

<verification>
- Draft can be created from installed module
- Edits are tracked with diffs
- Draft cannot be installed without sandbox validation
- Promotion creates new validated version with attestation
- Rollback moves pointer to prior version without rebuild
- All actions have audit records with actor + hashes
- RBAC enforces operator/admin role requirements
</verification>

<success_criteria>
- REQ-013: dev-mode supports safe modification of generated modules and reintegration
- REQ-016: reproducibility preserved via immutable bundles + audit trail + validated-only promotion/install
- Developer can: create draft -> edit -> diff -> validate -> promote -> install -> rollback
- Every step is auditable with actor identity and artifact hashes
</success_criteria>

<output>
After completion, create `.planning/phases/03-self-evolution-engine/03-06-SUMMARY.md`
</output>
