---
phase: 04-release-quality-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/admin/__init__.py
  - tests/integration/admin/conftest.py
  - tests/integration/admin/test_module_crud.py
  - tests/integration/admin/test_credential_ops.py
  - tests/integration/admin/test_config_hotreload.py
  - tests/integration/admin/test_billing_endpoints.py
autonomous: true

must_haves:
  truths:
    - "Admin API module CRUD (list, get, enable, disable) is exercised by integration tests"
    - "Admin API credential operations (set, check, delete) are exercised by integration tests"
    - "Admin API config hot-reload (get, put, patch, delete category, reload) is exercised by integration tests"
    - "Admin API billing endpoints (usage, history, quota) are exercised by integration tests"
    - "All tests run without Docker (mocked dependencies, in-process FastAPI TestClient)"
  artifacts:
    - path: "tests/integration/admin/test_module_crud.py"
      provides: "Module CRUD integration tests"
      min_lines: 80
    - path: "tests/integration/admin/test_credential_ops.py"
      provides: "Credential operation integration tests"
      min_lines: 50
    - path: "tests/integration/admin/test_config_hotreload.py"
      provides: "Config hot-reload integration tests"
      min_lines: 60
    - path: "tests/integration/admin/test_billing_endpoints.py"
      provides: "Billing endpoint integration tests"
      min_lines: 50
    - path: "tests/integration/admin/conftest.py"
      provides: "Shared fixtures: test app, auth headers, temp databases"
      min_lines: 30
  key_links:
    - from: "tests/integration/admin/conftest.py"
      to: "orchestrator/admin_api.py"
      via: "FastAPI TestClient wrapping _app"
      pattern: "TestClient|_app"
    - from: "tests/integration/admin/test_module_crud.py"
      to: "orchestrator/admin_api.py"
      via: "HTTP GET/POST to /admin/modules endpoints"
      pattern: "/admin/modules"
    - from: "tests/integration/admin/test_config_hotreload.py"
      to: "orchestrator/admin_api.py"
      via: "HTTP PUT/PATCH/POST to /admin/routing-config endpoints"
      pattern: "/admin/routing-config"
---

<objective>
Create comprehensive Admin API integration tests covering all CRUD operations (REQ-019).

Purpose: The Admin API has ~20 endpoints with RBAC enforcement, but no integration tests. Regressions from refactoring go undetected. These tests use FastAPI TestClient (in-process, no Docker required).

Output: `tests/integration/admin/` test suite covering module CRUD, credentials, config hot-reload, and billing endpoints.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@orchestrator/admin_api.py
@shared/auth/api_keys.py
@shared/auth/middleware.py
@shared/auth/rbac.py
@tests/auth/test_auth_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin API Test Infrastructure + Module CRUD Tests</name>
  <files>tests/integration/admin/__init__.py, tests/integration/admin/conftest.py, tests/integration/admin/test_module_crud.py</files>
  <action>
    **tests/integration/admin/__init__.py** — empty.

    **tests/integration/admin/conftest.py** — shared fixtures:
    - `admin_app` fixture: import `_app` from `orchestrator.admin_api`, configure with tmp_path databases (module registry, credentials, billing, routing config). Yield the FastAPI app configured for testing.
    - `client` fixture: `TestClient(admin_app)` from `starlette.testclient`
    - `admin_headers` fixture: create a test API key with admin role, return `{"X-API-Key": key}`. Use `APIKeyStore` from `shared.auth.api_keys` to bootstrap a test key.
    - `operator_headers` fixture: same pattern, operator role.
    - `viewer_headers` fixture: same pattern, viewer role.
    - Use `monkeypatch` or `tmp_path` to isolate all SQLite databases per test session.
    - Reference existing pattern in `tests/auth/test_auth_integration.py` for auth fixture approach.

    **tests/integration/admin/test_module_crud.py** — module endpoint tests:
    - `test_list_modules_empty` — GET /admin/modules with admin headers → 200, empty or default list
    - `test_list_modules_requires_auth` — GET /admin/modules without headers → 401
    - `test_get_module_not_found` — GET /admin/modules/nonexistent/platform → 404
    - `test_enable_module` — POST /admin/modules/{cat}/{plat}/enable with admin → 200
    - `test_enable_module_viewer_forbidden` — POST with viewer role → 403
    - `test_disable_module` — POST /admin/modules/{cat}/{plat}/disable with admin → 200
    - `test_health_endpoint_no_auth` — GET /admin/health → 200 (no auth required)
    - Each test verifies response status code AND response body structure
  </action>
  <verify>
    `python -m pytest tests/integration/admin/test_module_crud.py -v --tb=short` — all pass.
  </verify>
  <done>
    Module CRUD tests cover list, get, enable, disable, auth enforcement, RBAC.
    conftest provides reusable admin/operator/viewer fixtures.
    Health endpoint confirmed public.
  </done>
</task>

<task type="auto">
  <name>Task 2: Credential, Config, and Billing Integration Tests</name>
  <files>tests/integration/admin/test_credential_ops.py, tests/integration/admin/test_config_hotreload.py, tests/integration/admin/test_billing_endpoints.py</files>
  <action>
    **tests/integration/admin/test_credential_ops.py**:
    - `test_set_credential` — POST module credentials with admin → 200
    - `test_check_credential_exists` — check credential status after setting
    - `test_delete_credential` — delete credential with admin → 200
    - `test_credential_requires_admin` — operator/viewer cannot manage credentials (verify RBAC level)
    - Use the `conftest.py` admin_headers fixture from Task 1

    **tests/integration/admin/test_config_hotreload.py**:
    - `test_get_routing_config` — GET /admin/routing-config → 200, returns valid config structure
    - `test_put_routing_config` — PUT /admin/routing-config with new config → 200
    - `test_patch_category` — PATCH /admin/routing-config/category/{name} → 200
    - `test_delete_category` — DELETE /admin/routing-config/category/{name} → 200
    - `test_reload_config` — POST /admin/routing-config/reload → 200
    - `test_config_write_requires_permission` — viewer cannot PUT config → 403

    **tests/integration/admin/test_billing_endpoints.py**:
    - `test_get_usage_empty` — GET /admin/billing/usage → 200, empty or zero usage
    - `test_get_usage_history` — GET /admin/billing/usage/history → 200
    - `test_get_quota` — GET /admin/billing/quota → 200
    - `test_billing_requires_auth` — no headers → 401
    - Pre-insert a usage record via `UsageStore` fixture, then verify it appears in GET response
  </action>
  <verify>
    `python -m pytest tests/integration/admin/ -v --tb=short` — all pass (module + credential + config + billing).
  </verify>
  <done>
    Credential ops tests cover set, check, delete, RBAC enforcement.
    Config hot-reload tests cover full CRUD cycle + permission enforcement.
    Billing tests cover usage, history, quota endpoints with auth.
    Total: 20+ integration tests covering all Admin API surface area.
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/integration/admin/ -v` passes with 20+ tests
- All Admin API endpoints have at least one integration test
- Auth enforcement verified (401 without key, 403 for wrong role)
- No Docker dependency (all in-process via TestClient)
</verification>

<success_criteria>
- Module CRUD: list, get, enable, disable tested
- Credential ops: set, check, delete tested
- Config hot-reload: get, put, patch, delete category, reload tested
- Billing: usage, history, quota tested
- RBAC enforcement verified for viewer/operator/admin roles
- Zero test failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-release-quality-verification/04-02-SUMMARY.md`
</output>
