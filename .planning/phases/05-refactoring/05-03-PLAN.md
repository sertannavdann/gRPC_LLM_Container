---
phase: 05-refactoring
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - ui_service/src/lib/adapter-lock/adapters.ts
  - ui_service/src/lib/adapter-lock/base.ts
  - ui_service/src/app/api/adapters/route.ts
  - ui_service/src/app/finance/page.tsx
  - ui_service/src/app/api/finance/route.ts
  - orchestrator/orchestrator_service.py
  - tests/unit/test_draft_version_tools.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Adapter connections use the same lock/unlock pattern as providers from Phase 4"
    - "Adapter lock/unlock status reads from Admin API module registry, not hardcoded ADAPTER_DEFINITIONS"
    - "Finance page renders without an iframe — single API proxy path"
    - "DraftManager and VersionManager are registered as orchestrator chat tools"
    - "No direct .env file manipulation in adapter routes — credentials flow through Admin API"
    - "Chat agent can create drafts, edit drafts, diff, validate, promote, and rollback conversationally"
  artifacts:
    - path: "ui_service/src/lib/adapter-lock/base.ts"
      provides: "AdapterUnlockBase class matching ProviderUnlockBase pattern, with getRequiredFields(), isLocked(), testConnection() interface"
      exports: ["AdapterUnlockBase"]
      min_lines: 40
    - path: "ui_service/src/lib/adapter-lock/adapters.ts"
      provides: "Concrete adapter lock subclasses: WeatherAdapterLock, CalendarAdapterLock, FinanceAdapterLock, GamingAdapterLock"
      exports: ["WeatherAdapterLock", "CalendarAdapterLock", "FinanceAdapterLock", "GamingAdapterLock"]
      min_lines: 80
    - path: "ui_service/src/app/api/adapters/route.ts"
      provides: "Adapter registry route reading from Admin API, replacing hardcoded definitions"
      exports: ["GET", "POST", "DELETE"]
      min_lines: 60
    - path: "tests/unit/test_draft_version_tools.py"
      provides: "Tests for DraftManager + VersionManager tool registration in orchestrator"
      min_lines: 50
  key_links:
    - from: "ui_service/src/lib/adapter-lock/adapters.ts"
      to: "ui_service/src/lib/adapter-lock/base.ts"
      via: "extends AdapterUnlockBase"
      pattern: "extends AdapterUnlockBase"
    - from: "ui_service/src/app/api/adapters/route.ts"
      to: "ui_service/src/lib/adapter-lock/adapters.ts"
      via: "imports adapter lock subclasses for status resolution"
      pattern: "from.*adapter-lock/adapters"
    - from: "orchestrator/orchestrator_service.py"
      to: "shared/modules/drafts.py"
      via: "registers DraftManager methods as chat tools"
      pattern: "create_draft|edit_draft|promote_draft"
    - from: "orchestrator/orchestrator_service.py"
      to: "shared/modules/versioning.py"
      via: "registers VersionManager methods as chat tools"
      pattern: "list_versions|rollback_version"
---

<objective>
Unify adapter connections to use the Phase 4 lock/unlock pattern, wire DraftManager + VersionManager as orchestrator chat tools, and consolidate the finance backend path.

Purpose: Adapters currently use inline lambdas in hardcoded `ADAPTER_DEFINITIONS` and write directly to `.env` files — a completely different pattern from the provider lock/unlock established in Phase 4. DraftManager and VersionManager exist but aren't registered as orchestrator tools, so the chat agent can't manage module drafts. The finance page uses an iframe to a Docker-internal address that browsers can't resolve. This plan unifies all three.

Output: Adapter lock/unlock subclasses mirroring provider pattern, adapter registry route reading from Admin API, DraftManager/VersionManager tools in orchestrator, finance page without iframe, no `.env` file manipulation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-refactoring/05-CONTEXT.md
@.planning/phases/05-refactoring/05-01-SUMMARY.md

Academic anchors:
- Event-Driven Microservice Orchestration Principles: §4.1 (Saga pattern for multi-step connect flows), §5.3 (idempotency for credential store operations)
- Agentic Builder-Tester Pattern: §5.1 (Builder Agent tool registration), §6.1 (orchestrator-workers auto-prompt flow)

@ui_service/src/app/settings/providers/
@ui_service/src/lib/provider-lock/
@orchestrator/orchestrator_service.py
@shared/modules/drafts.py
@shared/modules/versioning.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Adapter lock/unlock base class and subclasses</name>
  <files>ui_service/src/lib/adapter-lock/base.ts, ui_service/src/lib/adapter-lock/adapters.ts</files>
  <action>
    Create `ui_service/src/lib/adapter-lock/base.ts`:
    - `AdapterUnlockBase` abstract class mirroring `ProviderUnlockBase` from Phase 4 (`ui_service/src/lib/provider-lock/`)
    - Abstract methods: `getRequiredFields(): FieldDefinition[]`, `isLocked(): boolean`, `testConnection(): Promise<ConnectionTestResult>`
    - `FieldDefinition` type: `{ name: string, label: string, type: 'text' | 'password' | 'file', required: boolean }`
    - `ConnectionTestResult` type: `{ success: boolean, message: string, latencyMs?: number }`
    - `getLockStatus()` method that checks if all required fields have values in the credential store

    Create `ui_service/src/lib/adapter-lock/adapters.ts`:
    - `WeatherAdapterLock extends AdapterUnlockBase` — required fields: `api_key` (OpenWeather API key), `base_url` (optional override). Test: GET /weather?q=London returns 200.
    - `CalendarAdapterLock extends AdapterUnlockBase` — required fields: `oauth_token` (Google OAuth2 token), `calendar_id` (target calendar). Test: GET /calendars/list returns 200.
    - `FinanceAdapterLock extends AdapterUnlockBase` — required fields: `csv_path` (CIBC CSV file path) OR `api_key` + `api_url` (for API mode). Test: file exists or API returns 200.
    - `GamingAdapterLock extends AdapterUnlockBase` — required fields: `api_key` (Clash Royale API key), `player_tag`. Test: GET /players/{tag} returns 200.
    - Each subclass reads current credential state from Admin API (`GET /admin/modules/{id}/credentials`) rather than from `.env`.

    Reference Phase 4 Plan 04 provider lock pattern for implementation consistency.
  </action>
  <verify>
    `npx tsc --noEmit ui_service/src/lib/adapter-lock/base.ts ui_service/src/lib/adapter-lock/adapters.ts` — no type errors.
    Each subclass instantiates without error and `getRequiredFields()` returns non-empty array.
  </verify>
  <done>
    Four adapter lock subclasses exist, all extending AdapterUnlockBase, each with typed required fields and connection test methods. Pattern matches Phase 4 provider lock.
  </done>
</task>

<task type="auto">
  <name>Task 2: Adapter registry route + remove .env manipulation</name>
  <files>ui_service/src/app/api/adapters/route.ts, ui_service/src/app/finance/page.tsx, ui_service/src/app/api/finance/route.ts</files>
  <action>
    Create `ui_service/src/app/api/adapters/route.ts`:
    - `GET` handler: reads installed modules from Admin API (`GET /admin/modules`), maps each to its adapter lock subclass, returns array of `{ id, name, category, status: 'connected' | 'locked' | 'error', requiredFields, missingFields }`.
    - `POST` handler: accepts `{ adapterId, credentials: Record<string, string> }`, stores credentials via Admin API (`POST /admin/modules/{id}/credentials`), runs `testConnection()`, returns result. NO `readFileSync`/`writeFileSync` of `.env`.
    - `DELETE` handler: accepts `{ adapterId }`, removes credentials via Admin API (`DELETE /admin/modules/{id}/credentials`), returns confirmation.
    - Derive user context from auth middleware — remove any `user_id=demo_user` hardcode.

    Update `ui_service/src/app/finance/page.tsx`:
    - Remove the iframe element entirely (`<iframe src="http://dashboard_service:8001/...">` or similar).
    - Replace with a placeholder page that shows lock/unlock status for the finance adapter using `FinanceAdapterLock.isLocked()`.
    - If locked: show unlock form (CSV path or API credentials fields from `getRequiredFields()`).
    - If unlocked: show "Finance data available — full page in Phase 6" with a basic data preview via the API proxy route.
    - Keep `ui_service/src/app/api/finance/route.ts` as the single API proxy (no iframe bypass).

    Remove all `.env` file I/O:
    - Search for `readFileSync` and `writeFileSync` referencing `.env` in adapter/dashboard routes.
    - Replace with Admin API credential store calls.
  </action>
  <verify>
    `grep -rn "readFileSync.*env\|writeFileSync.*env" ui_service/ | wc -l` returns 0.
    `grep -rn "demo_user" ui_service/src/app/api/ | wc -l` returns 0.
    `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0.
    `pnpm --filter ui_service build` succeeds without errors.
  </verify>
  <done>
    Adapter registry route reads from Admin API. No .env file manipulation. No demo_user hardcode. Finance page has no iframe — uses lock/unlock gating with API proxy path.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire DraftManager + VersionManager as orchestrator chat tools</name>
  <files>orchestrator/orchestrator_service.py, tests/unit/test_draft_version_tools.py</files>
  <action>
    Update `orchestrator/orchestrator_service.py`:
    - Import `DraftManager` from `shared.modules.drafts` and `VersionManager` from `shared.modules.versioning`
    - Register the following as orchestrator chat tools (same pattern as `build_module`, `repair_module`, `install_module`):
      - `create_draft(module_id: str) -> dict` — creates a new draft, returns draft metadata
      - `edit_draft(draft_id: str, changes: dict) -> dict` — applies changes to draft files
      - `diff_draft(draft_id: str) -> str` — returns unified diff of draft vs current version
      - `validate_draft(draft_id: str) -> dict` — runs validation pipeline on draft, returns ValidationResult
      - `promote_draft(draft_id: str) -> dict` — promotes validated draft to module version
      - `list_versions(module_id: str) -> list[dict]` — lists all versions with metadata
      - `rollback_version(module_id: str, version: int) -> dict` — rolls back to specified version
    - Each tool function: validates RBAC (draft ops = operator+, promote/rollback = admin+), calls the underlying manager method, returns structured response.
    - Tool descriptions should be clear for LLM consumption: the chat agent needs to understand when to call each tool.

    Academic anchor: Agentic Builder-Tester doc §6.1 — orchestrator dynamically dispatches to worker tools based on composed prompt. These tools enable the chat agent to manage the full module lifecycle conversationally.

    Create `tests/unit/test_draft_version_tools.py`:
    - Test `create_draft` tool is registered in orchestrator tool list
    - Test `edit_draft` tool receives changes dict and passes to DraftManager
    - Test `validate_draft` tool returns ValidationResult-shaped response
    - Test `promote_draft` requires admin role (mock RBAC check)
    - Test `rollback_version` requires admin role
    - Test `list_versions` returns list for known module
    - Test tools are discoverable by name in orchestrator tool registry
  </action>
  <verify>
    `python -c "from orchestrator.orchestrator_service import OrchestratorService; o = OrchestratorService.__new__(OrchestratorService); tools = [t for t in dir(o) if 'draft' in t or 'version' in t]; print(tools)"` — shows draft/version tool methods.
    `python -m pytest tests/unit/test_draft_version_tools.py -v --tb=short` — all pass.
    `grep -n "create_draft\|rollback_version" orchestrator/orchestrator_service.py | wc -l` >= 2.
  </verify>
  <done>
    DraftManager (5 tools) and VersionManager (2 tools) registered as orchestrator chat tools. RBAC enforced. Chat agent can manage module lifecycle conversationally. 7+ tests passing.
  </done>
</task>

</tasks>

<verification>
- `grep -rn "readFileSync.*env\|writeFileSync.*env" ui_service/ | wc -l` returns 0
- `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0
- `grep -rn "demo_user" ui_service/src/app/api/ | wc -l` returns 0
- `grep -n "create_draft\|edit_draft\|diff_draft\|validate_draft\|promote_draft\|list_versions\|rollback_version" orchestrator/orchestrator_service.py | wc -l` >= 7
- `python -m pytest tests/unit/test_draft_version_tools.py -v` — all pass
- `pnpm --filter ui_service build` — succeeds
- `make test-self-evolution` — zero regressions
</verification>

<success_criteria>
- Adapter lock/unlock follows same pattern as provider lock/unlock from Phase 4
- Adapter registry reads from Admin API, not hardcoded definitions
- No .env file manipulation in the entire ui_service codebase
- Finance page renders without iframe — uses API proxy + lock/unlock gating
- All 7 DraftManager/VersionManager operations available as orchestrator chat tools
- RBAC enforced on promote/rollback (admin+)
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/05-refactoring/05-03-SUMMARY.md`
</output>
