---
phase: 05-ui-contract-alignment
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - ui_service/src/app/settings/providers/page.tsx
  - ui_service/src/app/monitoring/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "/settings/providers page renders provider list from capability contract with lock/unlock state"
    - "Provider connection test runs inline with real-time result display"
    - "Locked providers show banner explaining what's missing (API key, base URL)"
    - "/monitoring page shows service health cards, agent runs table, and Grafana embeds — all from real data"
  artifacts:
    - path: "ui_service/src/app/settings/providers/page.tsx"
      provides: "Provider settings page with lock/unlock and connection test"
      min_lines: 100
    - path: "ui_service/src/app/monitoring/page.tsx"
      provides: "Monitoring page with service health, agent runs, Grafana tabs"
      min_lines: 100
  key_links:
    - from: "ui_service/src/app/settings/providers/page.tsx"
      to: "ui_service/src/hooks/useCapabilities.ts"
      via: "reads provider capability state"
      pattern: "useCapabilities\\("
    - from: "ui_service/src/app/settings/providers/page.tsx"
      to: "ui_service/src/app/api/settings/connection-test/route.ts"
      via: "calls connection test endpoint"
      pattern: "connection-test"
    - from: "ui_service/src/app/monitoring/page.tsx"
      to: "ui_service/src/lib/adminClient.ts"
      via: "fetches billing usage history for agent runs"
      pattern: "adminApi\\."
---

<objective>
Rewrite provider settings and monitoring pages as capability-driven components.

Purpose: The current settings page (632 lines) is a monolith mixing provider config, API keys, LIDM, and restart logic. The monitoring page (92 lines) only embeds Grafana iframes. This plan creates focused, capability-driven replacements that render from the backend contract.

Output: Provider settings page (/settings/providers) with lock/unlock + connection test. Enhanced monitoring page (/monitoring) with service health cards, agent runs table, and Grafana tabs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ui-contract-alignment/05-01-SUMMARY.md

@ui_service/src/app/settings/page.tsx
@ui_service/src/app/monitoring/page.tsx
@ui_service/src/lib/provider-lock/base.ts
@ui_service/src/lib/provider-lock/providers.ts
@ui_service/src/app/api/settings/connection-test/route.ts
@ui_service/src/lib/adminClient.ts
@ui_service/src/hooks/useCapabilities.ts
@docs/ui_contract.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Provider settings page (/settings/providers)</name>
  <files>
    ui_service/src/app/settings/providers/page.tsx
  </files>
  <action>
    **Generate visual shell with v0:**
    ```
    "Next.js settings page with shadcn/ui. Vertical list of LLM providers (local llama.cpp, OpenAI, Anthropic, Perplexity, NVIDIA NIM). Each row: provider name with icon, connection status indicator (connected green / locked amber / error red), config fields (API key input with show/hide toggle, base URL input, model selector dropdown), 'Test Connection' button with inline result message, lock/unlock toggle with tooltip. Locked providers show a yellow banner explaining what's missing. Dark mode. Tailwind."
    ```

    **Wire with Cursor:**
    - Get provider list from `useCapabilities().providers` — NOT from hardcoded `PROVIDER_META`
    - Provider lock status from capability envelope `ProviderCapability.locked` and `ProviderCapability.missing_requirements`
    - Connection test: POST to existing `/api/settings/connection-test` endpoint (already exists in `ui_service/src/app/api/settings/connection-test/route.ts`)
    - Model selector: populate from `ProviderCapability.available_models` array
    - API key inputs: still use `/api/settings` POST to save (existing route handles .env writes)
    - Show `DegradedBanner` for locked providers with `missing_requirements` as reasons
    - Connection test result shown inline below the Test button (success=green check, failure=red X with message)
    - Lock icon (lucide `Lock`/`Unlock`) next to provider name indicates lock state
    - Existing settings page (`/settings`) stays but links to `/settings/providers` for provider config. Do NOT delete the existing page yet — it has LIDM config that isn't migrated.
    
    **What NOT to include** (stays in existing `/settings` page for now):
    - LIDM delegation toggle and model selectors
    - Service restart functionality
    - Serper API key (web search, not an LLM provider)

    **Tool usage note**: Generate the provider list layout in **v0** using the prompt above. Use **Cursor Composer** to wire — it needs to read the existing connection-test route, provider-lock classes, and useCapabilities hook to connect everything correctly.
  </action>
  <verify>
    npx tsc --noEmit --project ui_service/tsconfig.json 2>&1 | head -20
    curl -s http://localhost:3000/settings/providers | head -5
  </verify>
  <done>
    /settings/providers renders provider list from capability contract.
    Locked providers show missing requirements banner.
    Connection test runs inline with real-time result display.
    Model selector populated from live provider data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced monitoring page (/monitoring)</name>
  <files>
    ui_service/src/app/monitoring/page.tsx
  </files>
  <action>
    **Generate visual shell with v0:**
    ```
    "Next.js monitoring page with shadcn/ui and three tabs. Tab 1 'Service Health': grid of 13 service cards, each showing service name, uptime badge (green/red), resource usage bar (CPU/memory percentage), and last-checked timestamp. Tab 2 'Agent Runs': data table with columns (run_id, module, status badge, latency_ms, token_count, timestamp) with sort by column and filter by status. Tab 3 'Dashboards': tabbed Grafana iframe embeds with 5 named dashboards (Overview, Service Health, Provider Comparison, Tool Execution, NEXUS Modules). Dark mode. Tailwind."
    ```

    **Wire with Cursor:**
    
    Tab 1 (Service Health):
    - Extend `adminClient.ts` with `getServiceHealth()` method (can call existing `/admin/health` or use capability envelope features)
    - For 13-container health: use `useCapabilities().features` to get service-level health
    - If detailed container metrics not available from capabilities, keep existing Grafana embed for now with a "View in Grafana" link
    - Show service status cards with: name, status badge (healthy/degraded/unavailable from feature health)
    
    Tab 2 (Agent Runs):
    - Extend `adminClient.ts` with `getBillingHistory(params)` method wrapping existing `GET /admin/billing/usage/history` endpoint
    - Table with client-side sort/filter
    - Status column: badge with color (success=green, error=red, pending=yellow)
    - Latency column: format as "123ms" or "1.2s"
    - Clickable run_id for future detail expansion (no-op for now)
    
    Tab 3 (Dashboards):
    - Keep existing Grafana iframe pattern from current monitoring page
    - Add NEXUS Modules dashboard to the list (already exists in Grafana)
    - Tab state persisted to localStorage (key: `nexus:monitoring:activeTab`)
    - Add "Open in Grafana" external link button per dashboard

    **Tool usage note**: Use **v0** for the tabbed layout with service cards + data table visual. Use **Cursor** to wire the data fetching — it understands the existing billing/usage endpoints and Grafana dashboard paths from the current monitoring page.
  </action>
  <verify>
    npx tsc --noEmit --project ui_service/tsconfig.json 2>&1 | head -20
    curl -s http://localhost:3000/monitoring | head -5
  </verify>
  <done>
    /monitoring renders three tabs: Service Health cards, Agent Runs table, Grafana dashboards.
    Service health cards show status from capability contract.
    Agent runs table fetches from billing history endpoint with sort/filter.
    Dashboard tab selection persisted to localStorage.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- /settings/providers renders 5 providers from capability contract
- Connection test for "local" provider returns success inline
- /monitoring Tab 1 shows service health cards
- /monitoring Tab 2 shows agent runs table (or empty state if no runs)
- /monitoring Tab 3 shows Grafana embeds with tab switching
</verification>

<success_criteria>
- Provider settings page is decoupled from the monolithic settings page
- All provider state comes from capability contract, not hardcoded metadata
- Monitoring page surfaces operational data beyond just Grafana iframes
- Both pages handle loading/error/degraded states consistently
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-contract-alignment/05-03-SUMMARY.md`
</output>
