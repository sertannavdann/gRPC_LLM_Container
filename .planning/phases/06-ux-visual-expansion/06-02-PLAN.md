---
phase: 06-ux-visual-expansion
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - ui_service/src/app/page.tsx
  - ui_service/src/components/dashboard/DataSourceIndicator.tsx
  - ui_service/src/components/dashboard/AdapterCard.tsx
  - ui_service/src/stores/nexusStore.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Dashboard page uses useNexusApp hook (XState-backed) for capability data — not ad-hoc useState/useEffect"
    - "Dashboard page renders adapter cards from the capability envelope — no hardcoded adapter list"
    - "Each adapter card shows name, status badge (connected/locked/error), last data timestamp, connect/disconnect button"
    - "Data source indicator shows Live / Mock / Offline with Framer Motion animated transitions"
    - "DataSourceIndicator derives state from XState parallel region dataSource (live/mock/offline)"
    - "Connect button triggers testConnection() before enabling the adapter"
    - "Disconnect removes credentials via Admin API, not .env file manipulation"
    - "Framer Motion layout animations on adapter card grid for add/remove transitions"
    - "Zustand store bridges chat tool call completion to XState CAPABILITY_REFRESH_REQUESTED event"
  artifacts:
    - path: "ui_service/src/app/page.tsx"
      provides: "Dashboard page rendering adapter cards from capability envelope, driven by XState useNexusApp hook"
      min_lines: 80
    - path: "ui_service/src/components/dashboard/DataSourceIndicator.tsx"
      provides: "Animated pill indicator showing Live/Mock/Offline status with Framer Motion transitions"
      exports: ["DataSourceIndicator"]
      min_lines: 30
    - path: "ui_service/src/components/dashboard/AdapterCard.tsx"
      provides: "Adapter card component with status badge, connect/disconnect actions, Framer Motion layout animation"
      exports: ["AdapterCard"]
      min_lines: 40
  key_links:
    - from: "ui_service/src/app/page.tsx"
      to: "ui_service/src/hooks/useNexusApp.ts"
      via: "uses useNexusApp hook for XState-backed capability data and dataSource status"
      pattern: "useNexusApp\\(\\)"
    - from: "ui_service/src/components/dashboard/DataSourceIndicator.tsx"
      to: "ui_service/src/hooks/useNexusApp.ts"
      via: "receives isLive/isMock/isOffline from XState dataSource parallel region"
      pattern: "isLive|isMock|isOffline"
    - from: "ui_service/src/app/page.tsx"
      to: "ui_service/src/app/api/adapters/route.ts"
      via: "connect/disconnect buttons call adapter API endpoints"
      pattern: "fetch.*api/adapters"
    - from: "ui_service/src/stores/nexusStore.ts"
      to: "ui_service/src/machines/nexusApp.ts"
      via: "triggerCapabilityRefresh dispatches CAPABILITY_REFRESH_REQUESTED via xstateSend"
      pattern: "triggerCapabilityRefresh"
---

<objective>
Build the dashboard page and adapter connectivity UI using XState-backed capability data with Framer Motion animated transitions.

Purpose: The current dashboard is 11 lines showing static content. This plan replaces it with a capability-driven dashboard that renders adapter cards from the backend contract. Data source status (Live/Mock/Offline) is derived from the XState nexusAppMachine's dataSource parallel region. Adapter cards use Framer Motion for layout animations. The Zustand store bridges chat tool call completion into XState events for immediate dashboard refresh.

Output: Dashboard page with adapter cards, Framer Motion DataSourceIndicator, adapter connect/disconnect flows, Zustand -> XState event bridge verified.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-visual-expansion/06-CONTEXT.md
@.planning/phases/06-ux-visual-expansion/06-01-SUMMARY.md

Visualization toolkit reference:
- XState v5: nexusAppMachine provides envelope, isLive, isMock, isOffline via useNexusApp hook
- Framer Motion v11+: AnimatePresence, motion.div, layout prop for animated card grid transitions
- Zustand bridge: nexusStore.triggerCapabilityRefresh() dispatches CAPABILITY_REFRESH_REQUESTED to XState

v0 prompt reference: Use v0 Premium to generate visual shell, then Cursor to wire.

@ui_service/src/hooks/useNexusApp.ts
@ui_service/src/machines/nexusApp.ts
@ui_service/src/lib/adminClient.ts
@ui_service/src/app/page.tsx
@ui_service/src/stores/nexusStore.ts
@docs/ui_contract.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard page rewrite with XState + adapter cards</name>
  <files>ui_service/src/app/page.tsx, ui_service/src/components/dashboard/AdapterCard.tsx</files>
  <action>
    **v0 Prompt** (generate visual shell in v0.dev first):
    ```
    Create a Next.js 14 dashboard page with shadcn/ui and Tailwind. Layout:
    - Header: "NEXUS Dashboard" with a data source indicator pill (green "Live", yellow "Mock", red "Offline")
    - Grid of adapter cards (responsive: 1 col mobile, 2 cols md, 3 cols lg):
      - Each card: adapter icon placeholder, adapter name, category badge, status badge (green "Connected", amber "Locked", red "Error")
      - Subtext: "Last data: 2 min ago" or "Not configured"
      - Action button: "Connect" (if locked) or "Disconnect" (if connected)
      - Connection test indicator: small dot showing test result
    - Below grid: feature health summary bar showing system-wide readiness
    Use Card, Badge, Button from shadcn/ui. Dark mode support.
    ```

    **Cursor wiring**:
    - Import and use `useNexusApp()` hook (XState-backed, from 06-01) — NOT a custom useCapabilities hook
    - Map `envelope.adapters` to AdapterCard components — do NOT hardcode adapter list
    - Status badge color: `connected` -> green, `locked` -> amber, `error` -> red
    - Connect button: calls `POST /api/adapters` with adapter ID -> runs testConnection() -> on success, `refresh()` triggers XState CAPABILITY_REFRESH_REQUESTED
    - Disconnect button: calls `DELETE /api/adapters` with adapter ID -> on success, `refresh()`
    - Data source indicator: uses `isLive`, `isMock`, `isOffline` from useNexusApp (derived from XState dataSource parallel region)
    - Loading state: skeleton cards while `isLoading` is true
    - Error state: DegradedBanner component (from Phase 6 Plan 04, or inline for now)
    - Feature health bar: maps `envelope.features` to colored segments

    Create `ui_service/src/components/dashboard/AdapterCard.tsx`:
    - Props: `adapter: AdapterCapability`, `onConnect: () => void`, `onDisconnect: () => void`
    - Framer Motion `motion.div` with `layout` prop for animated grid reflow on add/remove
    - `initial={{ opacity: 0, scale: 0.95 }}`, `animate={{ opacity: 1, scale: 1 }}`
    - Status dot with conditional Framer Motion pulse animation for degraded state
    - shadcn/ui Card, Badge, Button components
  </action>
  <verify>
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "useNexusApp" ui_service/src/app/page.tsx | wc -l` >= 1.
    `grep -rn "ADAPTER_DEFINITIONS\|hardcoded" ui_service/src/app/page.tsx | wc -l` returns 0.
    `grep -n "motion\|framer" ui_service/src/components/dashboard/AdapterCard.tsx | wc -l` >= 1.
    Dashboard renders adapter cards when navigated to in browser.
  </verify>
  <done>
    Dashboard page renders adapter cards from capability envelope via XState. Status badges show real-time lock/unlock state. Connect/disconnect flows through Admin API. Adapter cards animate with Framer Motion layout transitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Framer Motion DataSourceIndicator + Zustand bridge verification</name>
  <files>ui_service/src/components/dashboard/DataSourceIndicator.tsx, ui_service/src/stores/nexusStore.ts</files>
  <action>
    Create `ui_service/src/components/dashboard/DataSourceIndicator.tsx`:
    - Props: `status: 'live' | 'mock' | 'offline'`
    - Renders animated pill indicator using Framer Motion:
      - `live`: green dot with pulse animation (`animate={{ scale: [1, 1.4, 1], opacity: [1, 0.5, 1] }}`), label "Live"
      - `mock`: amber dot (no pulse), label "Mock"
      - `offline`: red dot (no pulse), label "Offline"
    - `motion.div` with `layout`, `key={status}` for AnimatePresence transitions between states
    - `initial={{ opacity: 0, scale: 0.8 }}`, `animate={{ opacity: 1, scale: 1 }}`, `transition={{ duration: 0.3 }}`
    - Uses shadcn/ui-compatible Tailwind classes, dark mode support
    - Status derived from XState dataSource parallel region via useNexusApp props

    Verify `ui_service/src/stores/nexusStore.ts` Zustand bridge:
    - Ensure `xstateSend` state and `setXStateSend` action exist (created in 06-01 Task 4)
    - Ensure `triggerCapabilityRefresh()` dispatches via `xstateSend?.({ type: 'CAPABILITY_REFRESH_REQUESTED' })`
    - This bridge is used by chat (06-03) and other pages to trigger XState refresh without direct machine access
  </action>
  <verify>
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "motion\|framer-motion" ui_service/src/components/dashboard/DataSourceIndicator.tsx | wc -l` >= 2.
    `grep -n "pulse\|animate" ui_service/src/components/dashboard/DataSourceIndicator.tsx | wc -l` >= 1.
    `grep -n "xstateSend\|CAPABILITY_REFRESH" ui_service/src/stores/nexusStore.ts | wc -l` >= 2.
    Data source indicator animates between Live/Mock/Offline states.
  </verify>
  <done>
    DataSourceIndicator shows animated Live/Mock/Offline pill driven by XState dataSource region. Zustand bridge dispatches CAPABILITY_REFRESH_REQUESTED to XState on chat tool call completion. Dashboard reflects real backend state with smooth transitions.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter ui_service build` — succeeds
- `useNexusApp` hook used in dashboard (not ad-hoc useState/useEffect)
- Dashboard page renders adapters from envelope, not hardcoded list
- Connect/disconnect buttons call adapter API (not .env)
- DataSourceIndicator animates between Live/Mock/Offline via Framer Motion
- Zustand bridge dispatches XState events for cross-page refresh
- No regressions in existing tests
</verification>

<success_criteria>
- Dashboard page renders entirely from capability envelope via XState-backed useNexusApp hook
- Adapter cards update in real-time as lock/unlock status changes
- XState invoked actors handle capability polling (no manual setInterval)
- DataSourceIndicator uses Framer Motion for animated state transitions
- Connect flow includes connection test before enabling
- Zustand -> XState bridge verified for chat tool call refresh
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-visual-expansion/06-02-SUMMARY.md`
</output>
