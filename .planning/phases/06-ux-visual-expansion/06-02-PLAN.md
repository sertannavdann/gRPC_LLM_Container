---
phase: 06-ux-visual-expansion
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - ui_service/src/hooks/useCapabilities.ts
  - ui_service/src/lib/adminClient.ts
  - ui_service/src/app/page.tsx
  - ui_service/src/stores/nexusStore.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "useCapabilities hook polls GET /admin/capabilities every 30s with ETag-based conditional fetch"
    - "Dashboard page renders adapter cards from the capability envelope — no hardcoded adapter list"
    - "Each adapter card shows name, status badge (connected/locked/error), last data timestamp, connect/disconnect button"
    - "Data source indicator shows Live / Mock / Offline based on backend reachability"
    - "Connect button triggers testConnection() before enabling the adapter"
    - "Disconnect removes credentials via Admin API, not .env file manipulation"
  artifacts:
    - path: "ui_service/src/hooks/useCapabilities.ts"
      provides: "React hook with 30s ETag-based polling against GET /admin/capabilities, typed CapabilityEnvelope return"
      exports: ["useCapabilities"]
      min_lines: 50
    - path: "ui_service/src/lib/adminClient.ts"
      provides: "Extended admin client with getCapabilities(etag?), getFeatureHealth(), getConfigVersion() methods"
      min_lines: 30
    - path: "ui_service/src/app/page.tsx"
      provides: "Dashboard page rendering adapter cards from capability envelope data"
      min_lines: 80
  key_links:
    - from: "ui_service/src/hooks/useCapabilities.ts"
      to: "ui_service/src/lib/adminClient.ts"
      via: "calls getCapabilities() with ETag for conditional fetch"
      pattern: "adminClient\\.getCapabilities"
    - from: "ui_service/src/app/page.tsx"
      to: "ui_service/src/hooks/useCapabilities.ts"
      via: "uses useCapabilities hook to get envelope data"
      pattern: "useCapabilities\\(\\)"
    - from: "ui_service/src/app/page.tsx"
      to: "ui_service/src/app/api/adapters/route.ts"
      via: "connect/disconnect buttons call adapter API endpoints"
      pattern: "fetch.*api/adapters"
---

<objective>
Build the dashboard page and adapter connectivity UI using capability envelope data from Phase 6 Plan 01.

Purpose: The current dashboard is 11 lines showing static content. This plan replaces it with a capability-driven dashboard that renders adapter cards from the backend contract. Each adapter shows its connection status, and users can connect/disconnect adapters through the lock/unlock flow established in Phase 5.

Output: `useCapabilities` hook with ETag polling, extended `adminClient.ts`, dashboard page with adapter cards showing live status from capability envelope.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-visual-expansion/06-CONTEXT.md
@.planning/phases/06-ux-visual-expansion/06-01-SUMMARY.md

v0 prompt reference: Use v0 Premium to generate visual shell, then Cursor to wire.

@ui_service/src/lib/adminClient.ts
@ui_service/src/app/page.tsx
@ui_service/src/stores/nexusStore.ts
@docs/ui_contract.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: useCapabilities hook + adminClient extension</name>
  <files>ui_service/src/hooks/useCapabilities.ts, ui_service/src/lib/adminClient.ts</files>
  <action>
    Extend `ui_service/src/lib/adminClient.ts`:
    - Add `getCapabilities(etag?: string): Promise<{ data: CapabilityEnvelope | null; etag: string; notModified: boolean }>` — sends `If-None-Match` header when etag provided. On 304 returns `{ data: null, etag, notModified: true }`. On 200 parses response, extracts ETag header, returns full envelope.
    - Add `getFeatureHealth(): Promise<FeatureHealth[]>` — fetches from `GET /admin/feature-health`
    - Add `getConfigVersion(): Promise<{ config_version: string; etag: string }>` — lightweight polling endpoint
    - TypeScript types for `CapabilityEnvelope`, `AdapterCapability`, etc. matching docs/ui_contract.md

    Create `ui_service/src/hooks/useCapabilities.ts`:
    - React hook returning `{ envelope: CapabilityEnvelope | null, isLoading: boolean, error: Error | null, isLive: boolean, isMock: boolean, isError: boolean, refresh: () => void }`
    - On mount: fetch full capabilities
    - Every 30s: poll `getConfigVersion()` — if ETag changed, fetch full capabilities; if 304, skip
    - `isLive`: envelope loaded and at least one adapter connected
    - `isMock`: envelope loaded but all adapters locked (showing mock/placeholder data)
    - `isError`: fetch failed or 401/500
    - `refresh()`: manually trigger immediate re-fetch (used by chat after tool calls)
    - Store current ETag in ref to avoid re-renders
    - Cleanup interval on unmount
  </action>
  <verify>
    `npx tsc --noEmit ui_service/src/hooks/useCapabilities.ts` — no type errors.
    `grep -n "If-None-Match\|ETag\|304" ui_service/src/lib/adminClient.ts | wc -l` >= 2.
    `grep -n "setInterval\|30.*1000\|30_000" ui_service/src/hooks/useCapabilities.ts | wc -l` >= 1.
  </verify>
  <done>
    useCapabilities hook polls every 30s with ETag-based conditional fetch. adminClient supports conditional requests. isLive/isMock/isError status derived from envelope data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page rewrite with adapter cards</name>
  <files>ui_service/src/app/page.tsx, ui_service/src/stores/nexusStore.ts</files>
  <action>
    **v0 Prompt** (generate visual shell in v0.dev first):
    ```
    Create a Next.js 14 dashboard page with shadcn/ui and Tailwind. Layout:
    - Header: "NEXUS Dashboard" with a data source indicator pill (green "Live", yellow "Mock", red "Offline")
    - Grid of adapter cards (responsive: 1 col mobile, 2 cols md, 3 cols lg):
      - Each card: adapter icon placeholder, adapter name, category badge, status badge (green "Connected", amber "Locked", red "Error")
      - Subtext: "Last data: 2 min ago" or "Not configured"
      - Action button: "Connect" (if locked) or "Disconnect" (if connected)
      - Connection test indicator: small dot showing test result
    - Below grid: feature health summary bar showing system-wide readiness
    Use Card, Badge, Button from shadcn/ui. Dark mode support.
    ```

    **Cursor wiring** (after pasting v0 output):
    - Import and use `useCapabilities()` hook
    - Map `envelope.adapters` to adapter cards — do NOT hardcode adapter list
    - Status badge color: `connected` → green, `locked` → amber, `error` → red
    - Connect button: calls `POST /api/adapters` with adapter ID → runs testConnection() → on success shows "Connected"
    - Disconnect button: calls `DELETE /api/adapters` with adapter ID → on success shows "Locked"
    - Data source indicator: uses `isLive`, `isMock`, `isError` from hook
    - Loading state: skeleton cards while envelope loads
    - Error state: DegradedBanner component (from Phase 6 Plan 04, or inline for now)
    - Feature health bar: maps `envelope.features` to colored segments

    Update `ui_service/src/stores/nexusStore.ts`:
    - Add `capabilityRefreshTrigger: number` state + `triggerCapabilityRefresh()` action
    - This allows chat and other pages to trigger dashboard refresh
  </action>
  <verify>
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "useCapabilities" ui_service/src/app/page.tsx | wc -l` >= 1.
    `grep -rn "ADAPTER_DEFINITIONS\|hardcoded" ui_service/src/app/page.tsx | wc -l` returns 0.
    Dashboard renders adapter cards when navigated to in browser.
  </verify>
  <done>
    Dashboard page renders adapter cards from capability envelope. Status badges show real-time lock/unlock state. Connect/disconnect flows through Admin API. Data source indicator shows Live/Mock/Offline.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter ui_service build` — succeeds
- `useCapabilities` hook exists with ETag-based polling
- Dashboard page renders adapters from envelope, not hardcoded list
- Connect/disconnect buttons call adapter API (not .env)
- Data source indicator reflects real backend state
- No regressions in existing tests
</verification>

<success_criteria>
- Dashboard page renders entirely from capability envelope data
- Adapter cards update in real-time as lock/unlock status changes
- ETag polling reduces unnecessary network traffic (304 on no change)
- Connect flow includes connection test before enabling
- Data source indicator clearly shows system state to user
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-visual-expansion/06-02-SUMMARY.md`
</output>
