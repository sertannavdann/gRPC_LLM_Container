---
phase: 06-ux-visual-expansion
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - ui_service/src/app/finance/page.tsx
  - ui_service/src/machines/financePage.ts
  - ui_service/src/components/finance/TransactionTable.tsx
  - ui_service/src/components/finance/SpendingChart.tsx
  - ui_service/src/components/chat/ActionCard.tsx
  - ui_service/src/app/chat/ChatContainer.tsx
  - ui_service/src/stores/nexusStore.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Finance page is a native Next.js page — no iframe"
    - "Finance page state managed by XState financePageMachine with hierarchical states: checking -> locked | unlocked"
    - "financePageMachine locked state has sub-states: idle -> testing -> succeeded | failed"
    - "financePageMachine unlocked state has sub-states: loading -> loaded | error"
    - "Connection test and data fetch are XState invoked actors (fromPromise), not ad-hoc useEffect"
    - "Recharts LineChart renders spending trend, PieChart renders category breakdown donut"
    - "Recharts charts use ResponsiveContainer with initialDimension for SSR compatibility"
    - "Framer Motion AnimatePresence manages page content transitions between locked/unlocked/loading/loaded states"
    - "Chat can trigger adapter actions (calendar.create_event, weather.get_forecast) with user confirmation"
    - "After any tool call in chat, Zustand dispatches CAPABILITY_REFRESH_REQUESTED to XState via xstateSend bridge"
    - "Action confirmation cards render inline in chat thread"
  artifacts:
    - path: "ui_service/src/machines/financePage.ts"
      provides: "XState v5 finance page machine with hierarchical locked/unlocked states, invoked actors for connection test and data fetch"
      exports: ["financePageMachine"]
      min_lines: 50
    - path: "ui_service/src/app/finance/page.tsx"
      provides: "Native finance page with XState-driven lock/unlock gating, Framer Motion transitions"
      min_lines: 80
    - path: "ui_service/src/components/finance/TransactionTable.tsx"
      provides: "Sortable transaction table component with columns: date, description, amount, category"
      exports: ["TransactionTable"]
      min_lines: 50
    - path: "ui_service/src/components/finance/SpendingChart.tsx"
      provides: "Recharts spending trend LineChart and category breakdown PieChart (donut)"
      exports: ["SpendingChart", "CategoryBreakdown"]
      min_lines: 60
    - path: "ui_service/src/components/chat/ActionCard.tsx"
      provides: "Chat action confirmation card for adapter tool calls with approve/reject buttons and Framer Motion state transitions"
      exports: ["ActionCard"]
      min_lines: 40
  key_links:
    - from: "ui_service/src/app/finance/page.tsx"
      to: "ui_service/src/machines/financePage.ts"
      via: "useMachine(financePageMachine) drives page rendering via state.matches()"
      pattern: "useMachine.*financePageMachine"
    - from: "ui_service/src/app/finance/page.tsx"
      to: "ui_service/src/hooks/useNexusApp.ts"
      via: "checks adapter lock status from XState root machine envelope"
      pattern: "useNexusApp\\(\\)"
    - from: "ui_service/src/components/finance/SpendingChart.tsx"
      to: "recharts"
      via: "uses Recharts LineChart, PieChart, ResponsiveContainer for data visualization"
      pattern: "from 'recharts'"
    - from: "ui_service/src/app/finance/page.tsx"
      to: "ui_service/src/app/api/finance/route.ts"
      via: "fetches financial data through API proxy (invoked by XState fetchFinanceData actor)"
      pattern: "fetch.*api/finance"
    - from: "ui_service/src/app/chat/ChatContainer.tsx"
      to: "ui_service/src/components/chat/ActionCard.tsx"
      via: "renders ActionCard when orchestrator response includes tool_calls"
      pattern: "ActionCard"
    - from: "ui_service/src/app/chat/ChatContainer.tsx"
      to: "ui_service/src/stores/nexusStore.ts"
      via: "triggers CAPABILITY_REFRESH_REQUESTED via Zustand xstateSend bridge after tool call completes"
      pattern: "triggerCapabilityRefresh"
---

<objective>
Build the native finance page with XState statechart state management, Recharts data visualization, and bidirectional chat actions with Framer Motion transitions.

Purpose: The finance page is currently an iframe stub pointing to a Docker-internal address. This plan creates a real data-driven page with: (1) XState financePageMachine managing the locked/unlocked hierarchy with invoked actors for connection testing and data fetching, (2) Recharts LineChart and PieChart for spending visualization, (3) Framer Motion AnimatePresence for animated page content transitions between states. Simultaneously, the chat interface gains structured action cards with Framer Motion state animations, and the Zustand -> XState bridge refreshes the dashboard after tool calls.

Output: XState finance machine, native finance page, Recharts chart components, chat action cards, bidirectional refresh wiring.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-visual-expansion/06-CONTEXT.md
@.planning/phases/06-ux-visual-expansion/06-01-SUMMARY.md

Visualization toolkit reference:
- XState v5: financePageMachine with hierarchical states (checking -> locked{idle,testing,failed,succeeded} | unlocked{loading,loaded,error})
- Recharts v2.15+: LineChart for spending trend, PieChart (innerRadius for donut) for category breakdown, ResponsiveContainer with initialDimension
- Framer Motion v11+: AnimatePresence mode="wait" for page content transitions driven by XState state.matches()
- Zustand bridge: triggerCapabilityRefresh() dispatches CAPABILITY_REFRESH_REQUESTED after chat tool calls

Academic anchors:
- Event-Driven Microservice Orchestration Principles: §4.1 (Saga for multi-step UI operations — connect -> test -> enable adapter), §6.1 (performance benchmarks — 43.7% throughput improvement over request-response)
- Agentic Builder-Tester Pattern: §6.1 (orchestrator-workers — chat dispatches to adapter tools based on user intent)

@ui_service/src/app/finance/page.tsx
@ui_service/src/app/api/finance/route.ts
@ui_service/src/app/chat/ChatContainer.tsx
@ui_service/src/lib/adapter-lock/adapters.ts
@ui_service/src/hooks/useNexusApp.ts
@ui_service/src/machines/nexusApp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: XState finance page machine + native page with Framer Motion transitions</name>
  <files>ui_service/src/machines/financePage.ts, ui_service/src/app/finance/page.tsx, ui_service/src/components/finance/TransactionTable.tsx, ui_service/src/components/finance/SpendingChart.tsx</files>
  <action>
    **Create `ui_service/src/machines/financePage.ts`** — XState v5 finance page statechart:
    - Uses `setup()` API with TypeScript typing
    - Guards: `financeAdapterLocked` checks `context.envelope?.adapters.find(a => a.category === 'finance')?.locked ?? true`
    - Invoked actors:
      - `testConnection`: fromPromise, calls `fetch('/api/adapters', { method: 'POST', body: ... })` for connection test
      - `fetchFinanceData`: fromPromise, calls `fetch('/api/finance').then(r => r.json())` for financial data
    - Hierarchical states:
      - `checking`: immediately transitions via guards to `locked` or `unlocked`
      - `locked`:
        - `idle`: waiting for user input, on SUBMIT_CREDENTIALS -> `testing`
        - `testing`: invokes testConnection actor, onDone -> `succeeded`, onError -> `failed`
        - `failed`: on SUBMIT_CREDENTIALS -> `testing`, on DISMISS -> `idle`
        - `succeeded`: final state, triggers parent onDone -> transitions to `unlocked`
      - `unlocked`:
        - `loading`: invokes fetchFinanceData actor, onDone -> `loaded` (assigns transactions to context), onError -> `error`
        - `loaded`: on REFRESH -> `loading`
        - `error`: on RETRY -> `loading`

    **v0 Prompt** (generate visual shell):
    ```
    Create a Next.js 14 finance dashboard page with shadcn/ui and Tailwind. Two states:

    State 1 — Locked (not configured):
    - Large lock icon centered
    - "Connect your finance source" heading
    - Form with fields: "CSV File Path" (text input) OR "API Key" + "API URL" (text inputs)
    - "Connect" button that tests connection first
    - Muted subtext: "Supports CIBC CSV exports and compatible finance APIs"

    State 2 — Unlocked (data available):
    - Summary cards row: Total Income (green), Total Expenses (red), Net Balance, Transaction Count
    - Left column (2/3 width): Transaction table with sortable columns (Date, Description, Amount, Category). Amounts color-coded (green positive, red negative). Pagination at bottom.
    - Right column (1/3 width): Category breakdown donut chart (top), Spending trend line chart (bottom, last 6 months).
    - All data from API, no hardcoded values.

    Use Card, Table, Badge, Input, Button from shadcn/ui. Dark mode support. Responsive layout.
    ```

    **Cursor wiring** for `ui_service/src/app/finance/page.tsx`:
    - Use `useMachine(financePageMachine)` for page state control
    - Use `useNexusApp()` to get envelope for guard context
    - Framer Motion `AnimatePresence mode="wait"` wraps page content:
      - `state.matches('locked')` -> renders unlock form with `motion.div key="locked" initial/animate/exit`
      - `state.matches('unlocked.loading')` -> renders TimeoutSkeleton with `motion.div key="loading"`
      - `state.matches('unlocked.loaded')` -> renders data view with `motion.div key="loaded" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }}`
    - Unlock form submit: `send({ type: 'SUBMIT_CREDENTIALS', credentials: formData })`
    - Error/failed states: use `state.matches('locked.failed')` or `state.matches('unlocked.error')` to show error UI

    **Create `ui_service/src/components/finance/TransactionTable.tsx`**:
    - Props: `transactions: Transaction[]` (date, description, amount, category)
    - Sortable columns using table head click handlers
    - Amount color coding: positive -> green, negative -> red
    - Client-side pagination (20 rows per page)
    - shadcn/ui Table component

    **Create `ui_service/src/components/finance/SpendingChart.tsx`**:
    - Export `SpendingChart`: Recharts `LineChart` inside `ResponsiveContainer` with `initialDimension={{ width: 400, height: 300 }}` for SSR
      - `CartesianGrid strokeDasharray="3 3"`, `XAxis dataKey="month"`, `YAxis`
      - `Line type="monotone" dataKey="amount" stroke="hsl(var(--primary))" strokeWidth={2}`
    - Export `CategoryBreakdown`: Recharts `PieChart` with `Pie innerRadius={60} outerRadius={100}` (donut)
      - `Cell` components with color palette supporting dark mode (`hsl(var(--chart-1))` etc.)
      - `ResponsiveContainer width="100%" height={250}`
    - Props accept data arrays, not raw API responses (separation of concerns)
  </action>
  <verify>
    `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0.
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "useMachine.*financePageMachine" ui_service/src/app/finance/page.tsx | wc -l` >= 1.
    `grep -n "AnimatePresence\|motion" ui_service/src/app/finance/page.tsx | wc -l` >= 2.
    `grep -n "LineChart\|PieChart\|ResponsiveContainer" ui_service/src/components/finance/SpendingChart.tsx | wc -l` >= 3.
    Finance page renders lock form when adapter is locked, data view when unlocked, with animated transitions.
  </verify>
  <done>
    XState financePageMachine manages page state with hierarchical locked/unlocked hierarchy. Finance page uses Framer Motion AnimatePresence for smooth transitions between states. Recharts LineChart and PieChart render spending data. No iframe. Data flows through API proxy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chat action cards + Zustand -> XState dashboard refresh</name>
  <files>ui_service/src/components/chat/ActionCard.tsx, ui_service/src/app/chat/ChatContainer.tsx, ui_service/src/stores/nexusStore.ts</files>
  <action>
    **Create `ui_service/src/components/chat/ActionCard.tsx`**:
    - Props: `toolCall: { id: string, name: string, arguments: Record<string, unknown> }`, `onApprove: (id: string) => void`, `onReject: (id: string) => void`, `status: 'pending' | 'executing' | 'completed' | 'failed'`
    - Framer Motion animated state transitions:
      - `pending`: buttons visible with `motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}`
      - `executing`: spinner with `motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity }}`
      - `completed`: green check with `motion.div initial={{ scale: 0 }} animate={{ scale: 1 }}`
      - `failed`: red warning with shake animation
    - Action name display: parse tool name (e.g., "calendar.create_event" -> "Calendar: Create Event")
    - Uses shadcn/ui Card, Button components

    **v0 Prompt** (for action card visual):
    ```
    Create a chat action confirmation card component with shadcn/ui. Card contains:
    - Icon + action title (e.g., "Calendar: Create Event")
    - Key-value argument display (event name, date, description)
    - Two buttons: green "Approve" with check icon, red "Reject" with X icon
    - States: pending (buttons visible), executing (spinner), completed (green check + result), failed (red warning + error message)
    Compact design for inline chat display. Dark mode support.
    ```

    **Update `ui_service/src/app/chat/ChatContainer.tsx`**:
    - Parse orchestrator responses for `tool_calls` field in message payloads
    - When response includes `tool_calls: [{ id, function: { name, arguments } }]`:
      - Render `ActionCard` inline in the chat thread for each tool call
      - On approve: send execution request to orchestrator
      - On reject: send rejection acknowledgment, continue conversation
    - After any tool call completes (approved and executed):
      - Call `triggerCapabilityRefresh()` from nexusStore — this dispatches `CAPABILITY_REFRESH_REQUESTED` to XState via `xstateSend` bridge
      - Show tool result inline in chat via ActionCard's completed state with Framer Motion transition

    **Verify `ui_service/src/stores/nexusStore.ts`**:
    - `triggerCapabilityRefresh()` dispatches via `xstateSend?.({ type: 'CAPABILITY_REFRESH_REQUESTED' })` (set up in 06-01)
    - This causes XState nexusAppMachine to re-enter capability.loading, fetching fresh envelope
    - Dashboard re-renders immediately without waiting for next 30s poll cycle
  </action>
  <verify>
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "ActionCard" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    `grep -n "tool_calls\|toolCalls" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    `grep -n "triggerCapabilityRefresh" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    `grep -n "motion\|framer" ui_service/src/components/chat/ActionCard.tsx | wc -l` >= 1.
    Chat renders action cards for tool calls, dashboard refreshes on completion via XState.
  </verify>
  <done>
    Chat displays action confirmation cards with Framer Motion state transitions. Approved actions execute and show results inline. Dashboard refreshes immediately via Zustand -> XState CAPABILITY_REFRESH_REQUESTED bridge.
  </done>
</task>

</tasks>

<verification>
- `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0
- `pnpm --filter ui_service build` — succeeds
- Finance page uses XState financePageMachine with useMachine (not ad-hoc state)
- Recharts LineChart and PieChart render financial data
- Framer Motion AnimatePresence transitions between locked/unlocked/loaded states
- Chat renders ActionCard with Framer Motion for tool_calls in orchestrator responses
- Dashboard triggers capability refresh via Zustand -> XState bridge after tool call completion
- No regressions in existing tests
</verification>

<success_criteria>
- Finance page is fully native with XState hierarchical states (locked/unlocked) — no iframe
- Connection test and data fetch are XState invoked actors (not ad-hoc useEffect)
- Recharts charts render spending trend (LineChart) and category breakdown (PieChart donut)
- Framer Motion AnimatePresence provides animated transitions between page states
- Chat action cards provide human-in-the-loop confirmation with Framer Motion state animations
- Dashboard updates immediately after chat-triggered tool calls via XState event dispatch
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-visual-expansion/06-03-SUMMARY.md`
</output>
