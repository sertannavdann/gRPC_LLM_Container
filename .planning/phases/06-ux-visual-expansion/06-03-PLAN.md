---
phase: 06-ux-visual-expansion
plan: 03
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - ui_service/src/app/finance/page.tsx
  - ui_service/src/components/finance/TransactionTable.tsx
  - ui_service/src/components/finance/SpendingChart.tsx
  - ui_service/src/components/chat/ActionCard.tsx
  - ui_service/src/app/chat/ChatContainer.tsx
  - ui_service/src/stores/nexusStore.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Finance page is a native Next.js page — no iframe"
    - "Finance page shows lock/unlock gating: if FinanceAdapterLock.isLocked(), show unlock form; otherwise show financial data"
    - "Financial data flows through single API proxy route, not direct Docker-internal calls"
    - "Chat can trigger adapter actions (calendar.create_event, weather.get_forecast) with user confirmation"
    - "After any tool call in chat, dashboard capability data refreshes immediately"
    - "Action confirmation cards render inline in chat thread"
  artifacts:
    - path: "ui_service/src/app/finance/page.tsx"
      provides: "Native finance page with lock/unlock gating, transaction table, category breakdown, spending trend"
      min_lines: 80
    - path: "ui_service/src/components/finance/TransactionTable.tsx"
      provides: "Sortable transaction table component with columns: date, description, amount, category"
      exports: ["TransactionTable"]
      min_lines: 50
    - path: "ui_service/src/components/finance/SpendingChart.tsx"
      provides: "Spending trend line chart and category breakdown donut chart"
      exports: ["SpendingChart", "CategoryBreakdown"]
      min_lines: 60
    - path: "ui_service/src/components/chat/ActionCard.tsx"
      provides: "Chat action confirmation card for adapter tool calls with approve/reject buttons"
      exports: ["ActionCard"]
      min_lines: 40
  key_links:
    - from: "ui_service/src/app/finance/page.tsx"
      to: "ui_service/src/hooks/useCapabilities.ts"
      via: "checks adapter lock status from capability envelope"
      pattern: "useCapabilities\\(\\)"
    - from: "ui_service/src/app/finance/page.tsx"
      to: "ui_service/src/app/api/finance/route.ts"
      via: "fetches financial data through API proxy"
      pattern: "fetch.*api/finance"
    - from: "ui_service/src/app/chat/ChatContainer.tsx"
      to: "ui_service/src/components/chat/ActionCard.tsx"
      via: "renders ActionCard when orchestrator response includes tool_calls"
      pattern: "ActionCard"
    - from: "ui_service/src/app/chat/ChatContainer.tsx"
      to: "ui_service/src/stores/nexusStore.ts"
      via: "triggers capabilityRefreshTrigger after tool call completes"
      pattern: "triggerCapabilityRefresh"
---

<objective>
Build the native finance page and add bidirectional chat actions — chat triggers adapter operations, dashboard refreshes immediately.

Purpose: The finance page is currently an iframe stub pointing to a Docker-internal address. This plan creates a real data-driven page with transaction table, spending charts, and lock/unlock gating. Simultaneously, the chat interface gains the ability to trigger adapter actions (create calendar event, get weather, etc.) with inline confirmation cards, and the dashboard refreshes immediately after any tool call.

Output: Native finance page, transaction/chart components, chat action cards, bidirectional refresh wiring.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-visual-expansion/06-CONTEXT.md
@.planning/phases/06-ux-visual-expansion/06-01-SUMMARY.md

Academic anchors:
- Event-Driven Microservice Orchestration Principles: §4.1 (Saga for multi-step UI operations — connect → test → enable adapter), §6.1 (performance benchmarks — 43.7% throughput improvement over request-response)
- Agentic Builder-Tester Pattern: §6.1 (orchestrator-workers — chat dispatches to adapter tools based on user intent)

@ui_service/src/app/finance/page.tsx
@ui_service/src/app/api/finance/route.ts
@ui_service/src/app/chat/ChatContainer.tsx
@ui_service/src/lib/adapter-lock/adapters.ts
@ui_service/src/hooks/useCapabilities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Finance page native rewrite with lock/unlock gating</name>
  <files>ui_service/src/app/finance/page.tsx, ui_service/src/components/finance/TransactionTable.tsx, ui_service/src/components/finance/SpendingChart.tsx</files>
  <action>
    **v0 Prompt** (generate visual shell):
    ```
    Create a Next.js 14 finance dashboard page with shadcn/ui and Tailwind. Two states:

    State 1 — Locked (not configured):
    - Large lock icon centered
    - "Connect your finance source" heading
    - Form with fields: "CSV File Path" (text input) OR "API Key" + "API URL" (text inputs)
    - "Connect" button that tests connection first
    - Muted subtext: "Supports CIBC CSV exports and compatible finance APIs"

    State 2 — Unlocked (data available):
    - Summary cards row: Total Income (green), Total Expenses (red), Net Balance, Transaction Count
    - Left column (2/3 width): Transaction table with sortable columns (Date, Description, Amount, Category). Amounts color-coded (green positive, red negative). Pagination at bottom.
    - Right column (1/3 width): Category breakdown donut chart (top), Spending trend line chart (bottom, last 6 months).
    - All data from API, no hardcoded values.

    Use Card, Table, Badge, Input, Button from shadcn/ui. Dark mode support. Responsive layout.
    ```

    **Cursor wiring**:
    - Import `useCapabilities()` to check finance adapter lock status from envelope
    - If `adapters.find(a => a.category === 'finance')?.locked === true`: render State 1 (unlock form)
    - Unlock form submit: `POST /api/adapters` with finance adapter ID + credentials → testConnection() → on success, trigger capability refresh → page re-renders to State 2
    - If unlocked: fetch financial data from `GET /api/finance` (existing API proxy route)
    - Map API response to TransactionTable and SpendingChart components
    - Loading state: skeleton table + chart placeholders
    - Error state: DegradedBanner with specific error message

    Create `ui_service/src/components/finance/TransactionTable.tsx`:
    - Props: `transactions: Transaction[]` (date, description, amount, category)
    - Sortable columns using table head click handlers
    - Amount color coding: positive → green, negative → red
    - Client-side pagination (20 rows per page)

    Create `ui_service/src/components/finance/SpendingChart.tsx`:
    - Export `SpendingChart`: line chart showing monthly spending trend (recharts or similar)
    - Export `CategoryBreakdown`: donut chart showing spend by category
    - Props accept data arrays, not raw API responses (separation of concerns)
    - Responsive sizing using container queries or aspect-ratio
  </action>
  <verify>
    `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0.
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "useCapabilities" ui_service/src/app/finance/page.tsx | wc -l` >= 1.
    Finance page renders lock form when adapter is locked, data view when unlocked.
  </verify>
  <done>
    Finance is a native page with lock/unlock gating. Transaction table with sorting/pagination. Spending charts with category breakdown. Data flows through API proxy. No iframe.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chat bidirectional actions + dashboard refresh</name>
  <files>ui_service/src/components/chat/ActionCard.tsx, ui_service/src/app/chat/ChatContainer.tsx, ui_service/src/stores/nexusStore.ts</files>
  <action>
    Create `ui_service/src/components/chat/ActionCard.tsx`:
    - Props: `toolCall: { id: string, name: string, arguments: Record<string, unknown> }`, `onApprove: (id: string) => void`, `onReject: (id: string) => void`, `status: 'pending' | 'executing' | 'completed' | 'failed'`
    - Renders: action name as heading (e.g., "Create Calendar Event"), argument summary (key-value pairs), approve (green) and reject (red) buttons
    - Status states: `pending` → shows buttons, `executing` → shows spinner, `completed` → shows success with result summary, `failed` → shows error message
    - Action name display: parse tool name (e.g., "calendar.create_event" → "Calendar: Create Event")

    **v0 Prompt** (for action card visual):
    ```
    Create a chat action confirmation card component with shadcn/ui. Card contains:
    - Icon + action title (e.g., "Calendar: Create Event")
    - Key-value argument display (event name, date, description)
    - Two buttons: green "Approve" with check icon, red "Reject" with X icon
    - States: pending (buttons visible), executing (spinner), completed (green check + result), failed (red warning + error message)
    Compact design for inline chat display. Dark mode support.
    ```

    Update `ui_service/src/app/chat/ChatContainer.tsx`:
    - Parse orchestrator responses for `tool_calls` field in message payloads
    - When response includes `tool_calls: [{ id, function: { name, arguments } }]`:
      - Render `ActionCard` inline in the chat thread for each tool call
      - On approve: send execution request to orchestrator (POST to chat/execute-tool or similar endpoint)
      - On reject: send rejection acknowledgment, continue conversation
    - After any tool call completes (approved and executed):
      - Call `triggerCapabilityRefresh()` from nexusStore — this causes useCapabilities to re-fetch immediately instead of waiting for next 30s poll
      - Show tool result inline in chat via ActionCard's completed state

    Update `ui_service/src/stores/nexusStore.ts` (if not already done in 06-02):
    - Ensure `capabilityRefreshTrigger` state exists
    - Ensure `triggerCapabilityRefresh()` action increments trigger counter
    - useCapabilities hook should watch this trigger to force re-fetch

    Agentic anchor: Agentic Builder-Tester doc §6.1 — the orchestrator dispatches tool calls to adapter workers based on user intent. The chat interface surfaces these as human-in-the-loop confirmations before execution.
  </action>
  <verify>
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "ActionCard" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    `grep -n "tool_calls\|toolCalls" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    `grep -n "triggerCapabilityRefresh" ui_service/src/app/chat/ChatContainer.tsx | wc -l` >= 1.
    Chat renders action cards for tool calls and dashboard refreshes on completion.
  </verify>
  <done>
    Chat displays action confirmation cards for adapter tool calls. User can approve/reject. Approved actions execute and show results inline. Dashboard refreshes immediately after tool completion via Zustand trigger.
  </done>
</task>

</tasks>

<verification>
- `grep -rn "iframe" ui_service/src/app/finance/ | wc -l` returns 0
- `pnpm --filter ui_service build` — succeeds
- Finance page uses useCapabilities for lock/unlock gating
- Chat renders ActionCard for tool_calls in orchestrator responses
- Dashboard triggers capability refresh after tool call completion
- No regressions in existing tests
</verification>

<success_criteria>
- Finance page is fully native with two states (locked/unlocked) driven by capability envelope
- Transaction table, spending charts render real data via API proxy
- Chat action cards provide human-in-the-loop confirmation for adapter operations
- Dashboard updates immediately after chat-triggered tool calls
- No iframe anywhere in the finance page
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-visual-expansion/06-03-SUMMARY.md`
</output>
