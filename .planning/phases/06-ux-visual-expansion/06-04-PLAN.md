---
phase: 06-ux-visual-expansion
plan: 04
type: execute
wave: 3
depends_on: [06-02, 06-03]
files_modified:
  - ui_service/src/app/monitoring/page.tsx
  - ui_service/src/machines/monitoringPage.ts
  - ui_service/src/components/monitoring/ServiceTopology.tsx
  - ui_service/src/components/monitoring/LatencyChart.tsx
  - ui_service/src/components/monitoring/PipelineStageFlow.tsx
  - ui_service/src/lib/errors.ts
  - ui_service/src/components/ui/error-states.tsx
  - shared/auth/user_prefs.py
  - orchestrator/admin_api.py
  - ui_service/src/hooks/useUserPrefs.ts
  - ui_service/src/components/nav/Navbar.tsx
  - ui_service/src/app/layout.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Monitoring page state managed by XState monitoringPageMachine with three parallel regions: health, latency, activeTab"
    - "Health and latency regions auto-refresh via XState invoked actors with configurable intervals (30s health, 60s latency)"
    - "React Flow v12 renders interactive service topology graph with custom ServiceNode components embedding shadcn/ui Cards and Badges"
    - "React Flow custom nodes show per-service status dot (green/amber/red) with Framer Motion pulse animation for DEGRADED status"
    - "React Flow service topology transforms CapabilityEnvelope features[] into nodes and edges"
    - "Recharts BarChart displays P99/P95/P50 latency per service with color coding and 500ms ReferenceLine target"
    - "React Flow PipelineStageNode renders build pipeline stages (scaffold/implement/test/repair) with animated borders for in-progress stages"
    - "Error taxonomy with 5 error types maps to visible error states across all pages via XState guards"
    - "DegradedBanner, EmptyState, TimeoutSkeleton components use Framer Motion for entry/exit animations"
    - "User preferences persist across page refreshes via SQLite backend with optimistic concurrency"
    - "Navigation reflects all 6 page routes: dashboard, modules, finance, monitoring, pipeline, settings"
    - "All pages wrap data fetches with error taxonomy mapping — no silent failures"
  artifacts:
    - path: "ui_service/src/machines/monitoringPage.ts"
      provides: "XState v5 monitoring page machine with parallel regions for health, latency, and activeTab"
      exports: ["monitoringPageMachine"]
      min_lines: 60
    - path: "ui_service/src/components/monitoring/ServiceTopology.tsx"
      provides: "React Flow v12 service topology graph with custom ServiceNode, MiniMap, Background, dark mode"
      exports: ["ServiceTopology", "ServiceNode"]
      min_lines: 80
    - path: "ui_service/src/components/monitoring/LatencyChart.tsx"
      provides: "Recharts BarChart for P99/P95/P50 latency with color coding and target ReferenceLine"
      exports: ["LatencyChart"]
      min_lines: 40
    - path: "ui_service/src/components/monitoring/PipelineStageFlow.tsx"
      provides: "React Flow pipeline stage visualization with PipelineStageNode for build run stages"
      exports: ["PipelineStageFlow", "PipelineStageNode"]
      min_lines: 50
    - path: "ui_service/src/app/monitoring/page.tsx"
      provides: "Monitoring page with service topology, latency chart, agent runs table, Grafana tabs, driven by XState"
      min_lines: 100
    - path: "ui_service/src/lib/errors.ts"
      provides: "Error taxonomy: NOT_AUTHORIZED, NOT_CONFIGURED, DEGRADED_PROVIDER, TOOL_SCHEMA_MISMATCH, TIMEOUT with XState guard integration"
      exports: ["NexusErrorType", "classifyError", "isRetryable"]
      min_lines: 40
    - path: "ui_service/src/components/ui/error-states.tsx"
      provides: "Error state components with Framer Motion: DegradedBanner, EmptyState, TimeoutSkeleton"
      exports: ["DegradedBanner", "EmptyState", "TimeoutSkeleton"]
      min_lines: 60
    - path: "shared/auth/user_prefs.py"
      provides: "SQLite user_prefs table with optimistic concurrency, CRUD functions"
      exports: ["UserPrefsStore", "UserPreferences"]
      min_lines: 60
    - path: "ui_service/src/hooks/useUserPrefs.ts"
      provides: "React hook for reading/writing user preferences with optimistic updates"
      exports: ["useUserPrefs"]
      min_lines: 40
  key_links:
    - from: "ui_service/src/app/monitoring/page.tsx"
      to: "ui_service/src/machines/monitoringPage.ts"
      via: "useMachine(monitoringPageMachine) drives monitoring page with parallel state regions"
      pattern: "useMachine.*monitoringPageMachine"
    - from: "ui_service/src/app/monitoring/page.tsx"
      to: "ui_service/src/hooks/useNexusApp.ts"
      via: "uses capability envelope for feature health display"
      pattern: "useNexusApp\\(\\)"
    - from: "ui_service/src/components/monitoring/ServiceTopology.tsx"
      to: "@xyflow/react"
      via: "React Flow v12 for interactive node graph with custom ServiceNode"
      pattern: "from '@xyflow/react'"
    - from: "ui_service/src/components/monitoring/LatencyChart.tsx"
      to: "recharts"
      via: "Recharts BarChart for latency percentiles"
      pattern: "from 'recharts'"
    - from: "ui_service/src/lib/errors.ts"
      to: "ui_service/src/components/ui/error-states.tsx"
      via: "error types drive component selection via XState guards"
      pattern: "NexusErrorType"
    - from: "orchestrator/admin_api.py"
      to: "shared/auth/user_prefs.py"
      via: "user prefs GET/PUT endpoints use UserPrefsStore"
      pattern: "user_prefs_store"
---

<objective>
Build monitoring page with React Flow service topology, Recharts latency charts, XState parallel state management, standardized error taxonomy, user preference persistence, and navigation updates.

Purpose: Monitoring currently shows 92 lines of basic stats. Error handling across pages is inconsistent — some fail silently, others crash. User preferences don't persist. This plan completes the UX layer with: (1) XState monitoringPageMachine with parallel regions for health/latency/tabs, (2) React Flow v12 interactive service topology with custom nodes embedding shadcn/ui components, (3) Recharts BarChart for P99/P95/P50 latency, (4) React Flow pipeline stage visualization, (5) error taxonomy with XState guards driving Framer Motion error components, (6) user preferences with SQLite persistence.

Output: XState monitoring machine, React Flow topology + pipeline components, Recharts latency chart, error taxonomy + 3 animated error components, user prefs backend + hook, updated navigation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary-minimal.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-visual-expansion/06-CONTEXT.md
@.planning/phases/06-ux-visual-expansion/06-02-SUMMARY.md
@.planning/phases/06-ux-visual-expansion/06-03-SUMMARY.md

Visualization toolkit reference:
- XState v5: monitoringPageMachine with parallel regions (health || latency || activeTab)
- React Flow v12 (@xyflow/react): Custom ServiceNode with Handles, embedded shadcn/ui Cards/Badges, Framer Motion pulse on DEGRADED, MiniMap, Background, dark mode
- Recharts v2.15+: BarChart with grouped bars (p50/p95/p99), ReferenceLine for 500ms target, color coding (green/amber/red)
- Framer Motion v11+: Error state component entry/exit animations, ServiceNode pulse for DEGRADED status

Academic anchors:
- Event-Driven Microservice Orchestration Principles: §6.1 (1.2s event-to-action latency target, P99 benchmarks), §5.1 (resilience theme T1 — failure-mode-pattern fit)
- Agentic Builder-Tester Pattern: §5 (agent monitoring — observability for build runs, repair attempts)

@ui_service/src/app/monitoring/page.tsx
@ui_service/src/components/nav/Navbar.tsx
@ui_service/src/app/layout.tsx
@data/verify_snapshot.json
@ui_service/src/hooks/useNexusApp.ts
@ui_service/src/machines/nexusApp.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: XState monitoring machine + React Flow service topology + Recharts latency</name>
  <files>ui_service/src/machines/monitoringPage.ts, ui_service/src/components/monitoring/ServiceTopology.tsx, ui_service/src/components/monitoring/LatencyChart.tsx, ui_service/src/components/monitoring/PipelineStageFlow.tsx, ui_service/src/app/monitoring/page.tsx</files>
  <action>
    **Create `ui_service/src/machines/monitoringPage.ts`** — XState v5 monitoring page statechart:
    - Uses `setup()` API with TypeScript typing
    - Invoked actors:
      - `fetchFeatureHealth`: fromPromise, calls `adminClient.getFeatureHealth()`
      - `fetchLatencySnapshot`: fromPromise, calls `fetch('/api/monitoring/latency').then(r => r.json())`
    - Three parallel state regions (type: 'parallel'):
      1. **health**: `loading -> loaded | error` cycle. `loaded` auto-refreshes after 30s via `after`. `error` auto-retries after 5s.
      2. **latency**: `loading -> loaded | error` cycle. `loaded` auto-refreshes after 60s. `error` auto-retries after 10s.
      3. **activeTab**: `overview | modules | alerts`. Transitions on `TAB_OVERVIEW`, `TAB_MODULES`, `TAB_ALERTS` events.

    **Create `ui_service/src/components/monitoring/ServiceTopology.tsx`** — React Flow v12 service topology:
    - Custom `ServiceNode` component:
      - Renders inside React Flow node using `Handle` for source/target connections
      - Embeds shadcn/ui Card with service name, status badge
      - Status dot color mapped from FeatureHealth: `HEALTHY` -> green, `DEGRADED` -> amber, `UNAVAILABLE` -> red, `UNKNOWN` -> gray
      - Framer Motion pulse animation on DEGRADED status: `animate={{ scale: [1, 1.02, 1] }} transition={{ repeat: Infinity, duration: 2 }}`
      - P99 Badge: shows `P99: {value}ms` with `variant={value > 500 ? 'destructive' : 'secondary'}`
    - `envelopeToTopology()` function:
      - Transforms `CapabilityEnvelope.features[]` + latency data into React Flow nodes and edges
      - Service positions: orchestrator (center-top), llm-gateway/sandbox/chromadb (middle row), ui/dashboard/bridge (bottom row)
      - Animated edges between services (`animated: true` for active connections)
    - React Flow components: `ReactFlow`, `Background`, `MiniMap`, `Controls`
    - Dark mode support via React Flow v12 native theming
    - Register custom node types: `{ serviceNode: ServiceNode }`

    **Create `ui_service/src/components/monitoring/LatencyChart.tsx`** — Recharts latency:
    - Recharts `BarChart` inside `ResponsiveContainer width="100%" height={300}`
    - Grouped bars: `p50` (green #22c55e), `p95` (amber #f59e0b), `p99` (red #ef4444)
    - `XAxis dataKey="service"`, `YAxis label={{ value: 'ms', position: 'insideLeft' }}`
    - `ReferenceLine y={500}` at P99 target line (dashed red, label "P99 Target")
    - `CartesianGrid strokeDasharray="3 3"`, `Tooltip`
    - Props: `data: ServiceLatency[]` (service, p50, p95, p99)

    **Create `ui_service/src/components/monitoring/PipelineStageFlow.tsx`** — React Flow pipeline:
    - Custom `PipelineStageNode` component:
      - Stage-specific border colors: scaffold (blue), implement (purple), test (amber), repair (red)
      - Framer Motion animated border for in-progress stages: `animate={{ borderColor: ['#3b82f6', '#8b5cf6', '#3b82f6'] }}`
      - Shows stage name, attempt count (`Attempt {n}/10`)
      - Handle connections: left (target) to right (source) for horizontal flow
    - Transforms agent run data into horizontal stage flow: scaffold -> implement -> test -> repair

    **v0 Prompt** (generate monitoring page visual shell):
    ```
    Create a Next.js 14 monitoring dashboard page with shadcn/ui and Tailwind. Sections:

    1. Service Health Grid (top): Cards for each service (Orchestrator, Dashboard, UI, LLM Gateway, Sandbox, ChromaDB, Bridge). Each card shows: service name, status dot (green/amber/red), uptime percentage, last health check time.

    2. Latency Panel (middle): Bar chart showing P50, P95, P99 latency per service. Values in ms with color coding: green < 200ms, amber < 500ms, red > 500ms. Target line at 500ms.

    3. Agent Runs Table (bottom left, 2/3 width): Table with columns: Build ID, Module, Stage, Status, Duration, Attempts. Last 20 runs.

    4. Grafana Embed (bottom right, 1/3 width): Tab group with "Overview", "Modules", "Alerts" tabs.

    Use Card, Table, Tabs, Badge from shadcn/ui. Dark mode support.
    ```

    **Cursor wiring** for `ui_service/src/app/monitoring/page.tsx`:
    - Use `useMachine(monitoringPageMachine)` for page state with parallel regions
    - Use `useNexusApp()` for feature health data
    - Service topology: render `ServiceTopology` component with React Flow, passing envelope features + latency data
    - Latency panel: render `LatencyChart` with Recharts, data from latency parallel region
    - Pipeline flow: render `PipelineStageFlow` with React Flow for recent build runs
    - Tab navigation: `send({ type: 'TAB_OVERVIEW' })` etc., driven by XState activeTab region
    - Loading states: skeleton cards while health/latency regions are in `loading` state
    - Error handling: wrap all data fetches with `classifyError()` from error taxonomy (Task 2)
    - Dynamic imports for React Flow and Recharts: `next/dynamic` with SSR disabled for client-only rendering
  </action>
  <verify>
    `wc -l ui_service/src/app/monitoring/page.tsx | awk '{print $1}'` >= 100.
    `pnpm --filter ui_service build` — succeeds.
    `grep -n "useMachine.*monitoringPageMachine" ui_service/src/app/monitoring/page.tsx | wc -l` >= 1.
    `grep -n "ReactFlow\|xyflow" ui_service/src/components/monitoring/ServiceTopology.tsx | wc -l` >= 1.
    `grep -n "BarChart\|ReferenceLine" ui_service/src/components/monitoring/LatencyChart.tsx | wc -l` >= 2.
    `grep -n "motion\|framer" ui_service/src/components/monitoring/ServiceTopology.tsx | wc -l` >= 1.
    Monitoring page renders service topology, latency chart, and agent runs.
  </verify>
  <done>
    XState monitoringPageMachine manages parallel health/latency/tab regions. React Flow v12 renders interactive service topology with custom nodes. Recharts BarChart shows P99/P95/P50 latency with target line. Pipeline stage flow visualizes build runs. All auto-refreshing via XState invoked actors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Error taxonomy with XState guards + Framer Motion error components + user preferences</name>
  <files>ui_service/src/lib/errors.ts, ui_service/src/components/ui/error-states.tsx, shared/auth/user_prefs.py, orchestrator/admin_api.py, ui_service/src/hooks/useUserPrefs.ts</files>
  <action>
    **Create `ui_service/src/lib/errors.ts`**:
    - `NexusErrorType` enum: `NOT_AUTHORIZED`, `NOT_CONFIGURED`, `DEGRADED_PROVIDER`, `TOOL_SCHEMA_MISMATCH`, `TIMEOUT`
    - `classifyError(error: unknown): NexusErrorType` — maps HTTP status codes and error shapes:
      - 401/403 -> NOT_AUTHORIZED
      - 404 on provider/adapter + missing config -> NOT_CONFIGURED
      - 502/503 on provider endpoint -> DEGRADED_PROVIDER
      - JSON parse error or unexpected response shape -> TOOL_SCHEMA_MISMATCH
      - Timeout / AbortError -> TIMEOUT
    - `isRetryable(type: NexusErrorType): boolean` — TIMEOUT and DEGRADED_PROVIDER are retryable; maps to XState `isRetryableError` guard
    - `errorMessage(type: NexusErrorType): string` — user-friendly message for each type
    - XState integration: `isRetryable` function is used by nexusAppMachine's `isRetryableError` guard for auto-retry decisions

    **Create `ui_service/src/components/ui/error-states.tsx`**:
    - `DegradedBanner`: amber banner with warning icon, message, optional "Retry" button
      - Framer Motion: `initial={{ opacity: 0, y: -10 }}`, `animate={{ opacity: 1, y: 0 }}`, `exit={{ opacity: 0, y: -10 }}`
      - Shows when XState feature is DEGRADED. Props: `feature: string`, `reasons: string[]`, `onRetry?: () => void`
    - `EmptyState`: centered illustration placeholder + message + optional action button
      - Framer Motion: `initial={{ opacity: 0, scale: 0.9 }}`, `animate={{ opacity: 1, scale: 1 }}`
      - Shows when no data available. Props: `title: string`, `description: string`, `action?: { label: string, onClick: () => void }`
    - `TimeoutSkeleton`: skeleton UI with "Taking longer than usual..." overlay after 5s
      - Framer Motion: overlay `animate={{ opacity: [0, 1] }}` after delay
      - Shows during slow XState loading states. Props: `children: ReactNode`
    - All components use shadcn/ui primitives (Alert, Skeleton, Button)

    **Create `shared/auth/user_prefs.py`**:
    - `UserPreferences` Pydantic model: `theme: str` (light/dark/system), `provider_ordering: list[str]`, `module_favorites: list[str]`, `monitoring_tab: str` (overview/modules/alerts), `dashboard_layout: dict | None`
    - `UserPrefsStore` class: SQLite `user_prefs` table (user_id TEXT PK, prefs_json TEXT, version INTEGER, updated_at TEXT)
    - `get_prefs(user_id: str) -> UserPreferences` — returns defaults if no record
    - `set_prefs(user_id: str, prefs: UserPreferences, expected_version: int) -> int` — optimistic concurrency: raise ConflictError if version mismatch
    - WAL-mode SQLite

    **Add endpoints to `orchestrator/admin_api.py`**:
    - `GET /admin/user/prefs` — returns user's preferences + version (user from auth context)
    - `PUT /admin/user/prefs` — accepts `{ prefs, version }`, optimistic concurrency, returns 409 on conflict

    **Create `ui_service/src/hooks/useUserPrefs.ts`**:
    - Returns `{ prefs, updatePrefs, isLoading, isSaving }`
    - Optimistic updates: apply locally first, PUT to backend, on 409 conflict re-fetch and merge
    - Version tracking in ref for concurrency
    - XState integration: monitoring_tab preference syncs with monitoringPageMachine activeTab region
  </action>
  <verify>
    `python -c "from shared.auth.user_prefs import UserPrefsStore, UserPreferences; print('ok')"` succeeds.
    `grep -n "NOT_AUTHORIZED\|DEGRADED_PROVIDER\|TIMEOUT" ui_service/src/lib/errors.ts | wc -l` >= 3.
    `grep -n "DegradedBanner\|EmptyState\|TimeoutSkeleton" ui_service/src/components/ui/error-states.tsx | wc -l` >= 3.
    `grep -n "motion\|framer" ui_service/src/components/ui/error-states.tsx | wc -l` >= 2.
    `grep -n "isRetryable" ui_service/src/lib/errors.ts | wc -l` >= 1.
  </verify>
  <done>
    Error taxonomy with 5 types + Framer Motion animated error components. isRetryable maps to XState guard for auto-retry. User preferences persist via SQLite with optimistic concurrency. GET/PUT /admin/user/prefs endpoints wired.
  </done>
</task>

<task type="auto">
  <name>Task 3: Navigation update + full QA pass</name>
  <files>ui_service/src/components/nav/Navbar.tsx, ui_service/src/app/layout.tsx</files>
  <action>
    **Update `ui_service/src/components/nav/Navbar.tsx`**:
    - Navigation links for all 6 pages:
      - Dashboard (/) — home/overview
      - Modules (/modules) — module browser with lifecycle panel
      - Finance (/finance) — financial data + charts
      - Monitoring (/monitoring) — service health + P99 + agent runs
      - Pipeline (/pipeline) — build job viewer (existing)
      - Settings (/settings/providers) — provider configuration with lock/unlock
    - Active page highlighting based on current route
    - Responsive: hamburger menu on mobile, sidebar or horizontal nav on desktop
    - Framer Motion: subtle `motion.div` with `layout` on active indicator

    **Update `ui_service/src/app/layout.tsx`**:
    - Ensure Navbar is rendered in layout for all pages
    - Wrap children with error boundary that uses `classifyError()` and renders `DegradedBanner` on unhandled errors
    - XState integration: nexusAppMachine context provided at layout level so all pages share the same machine instance

    **Full QA verification to close Phase 6**:
    - Navigate to each of the 6 pages and confirm rendering
    - Verify XState machines: nexusAppMachine (root), financePageMachine (06-03), monitoringPageMachine (06-04)
    - Verify React Flow: service topology renders nodes + edges, pipeline stages animate
    - Verify Recharts: finance LineChart/PieChart, monitoring BarChart
    - Verify Framer Motion: DataSourceIndicator transitions, page content AnimatePresence, error component animations, adapter card layout
    - Verify error states: disconnect an adapter -> DegradedBanner appears
    - Verify data source indicator on dashboard (Live/Mock/Offline)
    - Verify finance lock/unlock gating with XState state transitions
    - Verify monitoring P99 display with Recharts
    - Verify chat action cards with Framer Motion state animations
    - Verify Zustand -> XState bridge: chat tool call triggers immediate dashboard refresh
    - Run `make verify` — all existing tests pass with zero regressions
    - P99 latency target: all active service endpoints respond < 500ms at p99
  </action>
  <verify>
    `grep -n "Dashboard\|Modules\|Finance\|Monitoring\|Pipeline\|Settings" ui_service/src/components/nav/Navbar.tsx | wc -l` >= 6.
    `pnpm --filter ui_service build` — succeeds.
    `make verify` — all tests pass.
    All 6 pages accessible via navigation and render without errors.
  </verify>
  <done>
    Navigation updated for all 6 pages. Error taxonomy with XState guards applied across all pages. Framer Motion animations on error components. User preferences persist. React Flow topology and Recharts latency verified. XState machines functioning across all pages. P99 target met. make verify passes.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter ui_service build` — succeeds
- `make verify` — all tests pass
- XState monitoringPageMachine manages parallel health/latency/tab regions
- React Flow v12 renders service topology with custom ServiceNode + pipeline stages
- Recharts BarChart shows P99/P95/P50 with ReferenceLine target
- Framer Motion animations on error components, ServiceNode pulse, pipeline borders
- Error taxonomy (5 types) standardizes error handling — no silent failures
- User preferences persist via SQLite with optimistic concurrency
- Navigation includes all 6 page routes
- P99 latency < 500ms for all active services
</verification>

<success_criteria>
- Monitoring page provides complete observability via XState parallel regions: health cards, latency percentiles, agent runs, Grafana tabs
- React Flow v12 interactive service topology with custom nodes showing real-time status and P99
- Recharts latency chart with grouped bars and 500ms target reference line
- Pipeline stage visualization with React Flow PipelineStageNode
- Error taxonomy drives XState guards for auto-retry decisions
- Framer Motion animations on all error state components
- User preferences persist via SQLite with optimistic concurrency
- Navigation reflects full page structure
- All pages render from capability contract via XState machines
- make verify passes with zero regressions
- P99 latency target met (< 500ms) for all active service endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-visual-expansion/06-04-SUMMARY.md`
</output>
