groups:
  - name: decision_pipeline
    rules:
      # High inference latency (>5s for non-ultra tiers)
      - alert: HighInferenceLatency
        expr: histogram_quantile(0.95, rate(pipeline_inference_duration_ms_bucket[5m])) > 5000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "p95 inference latency exceeds 5s"
          description: "95th percentile inference duration is {{ $value | humanize }}ms"

      # Excessive LIDM delegation errors (>10% rate)
      - alert: LIDMDelegationErrors
        expr: rate(lidm_delegation_errors_total[5m]) / (rate(lidm_delegation_requests_total[5m]) + 0.001) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "LIDM delegation error rate exceeds 10%"

      # Tool execution failures (>10% error rate)
      - alert: ToolExecutionFailures
        expr: rate(tool_errors_total[5m]) / (rate(tool_calls_total[5m]) + 0.001) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Tool execution error rate exceeds 10%"

      # Memory pressure (RSS > 4GB)
      - alert: HighMemoryUsage
        expr: process_memory_rss_bytes > 4294967296
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Process RSS exceeds 4GB"
          description: "Current RSS: {{ $value | humanize }}B"

      # Low token generation rate (<1 token/sec sustained)
      - alert: LowTokenGenerationRate
        expr: histogram_quantile(0.5, rate(pipeline_token_generation_rate_bucket[5m])) < 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Median token generation rate below 1 tok/s"

      # Context window saturation (>90%)
      - alert: ContextWindowSaturation
        expr: pipeline_context_utilization > 0.9
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Context window utilization above 90%"

  - name: nexus_modules
    rules:
      # Module validation failure spike
      - alert: ModuleValidationFailures
        expr: rate(nexus_module_validations_total{result="fail"}[10m]) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High module validation failure rate"
          description: "Module validations are failing at {{ $value | humanize }}/s"

      # Modules in failed state
      - alert: ModulesInFailedState
        expr: nexus_module_status{status="failed"} > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "{{ $value }} module(s) in failed state"

  - name: container_resources
    rules:
      # Container high CPU usage (>80% of a core for 5 min)
      - alert: ContainerHighCPU
        expr: rate(container_cpu_usage_seconds_total{name=~"orchestrator|llm_service|dashboard_service"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.name }} CPU usage above 80%"

      # Container high memory (>2GB)
      - alert: ContainerHighMemory
        expr: container_memory_usage_bytes{name=~"orchestrator|llm_service|dashboard_service"} > 2147483648
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container {{ $labels.name }} memory above 2GB"
          description: "Current: {{ $value | humanize }}B"
