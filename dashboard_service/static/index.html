<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-card: #1c2128;
    --bg-hover: #252d38;
    --border: #30363d;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent: #f97316;
    --accent-dim: rgba(249,115,22,0.15);
    --green: #3fb950;
    --green-dim: rgba(63,185,80,0.15);
    --red: #f85149;
    --red-dim: rgba(248,81,73,0.15);
    --blue: #58a6ff;
    --purple: #bc8cff;
    --radius: 12px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    min-height: 100vh;
  }

  .container { max-width: 1440px; margin: 0 auto; padding: 24px; }

  header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 28px; padding-bottom: 16px; border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 1.5rem; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .header-meta { color: var(--text-secondary); font-size: 0.85rem; }

  /* Summary Cards */
  .summary-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px; margin-bottom: 28px;
  }
  .card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px;
  }
  .card-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 6px; }
  .card-value { font-size: 1.75rem; font-weight: 700; }
  .card-value.expense { color: var(--red); }
  .card-value.income { color: var(--green); }
  .card-value.neutral { color: var(--blue); }
  .card-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }

  /* Filter Bar */
  .filter-bar {
    display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;
    padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: var(--radius); align-items: flex-end;
  }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .filter-group label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
  .filter-group input, .filter-group select {
    background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 8px 12px; font-size: 0.85rem; outline: none;
  }
  .filter-group input:focus, .filter-group select:focus { border-color: var(--accent); }
  .filter-group input[type="date"] { min-width: 140px; }
  .btn {
    padding: 8px 18px; border-radius: var(--radius-sm); font-size: 0.85rem;
    font-weight: 500; cursor: pointer; border: 1px solid var(--border);
    background: var(--accent); color: #fff; border-color: var(--accent);
    transition: opacity 0.15s;
  }
  .btn:hover { opacity: 0.85; }
  .btn-secondary { background: var(--bg-card); color: var(--text-primary); border-color: var(--border); }

  /* Charts Grid */
  .charts-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px;
  }
  .chart-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px;
  }
  .chart-card h3 { font-size: 0.9rem; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary); }
  .chart-container { position: relative; height: 280px; }

  /* Transaction Table */
  .table-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
  }
  .table-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
  }
  .table-header h3 { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    text-align: left; padding: 10px 16px; font-size: 0.75rem;
    text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);
    border-bottom: 1px solid var(--border); cursor: pointer; user-select: none;
  }
  thead th:hover { color: var(--text-primary); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:hover { background: var(--bg-hover); }
  tbody td { padding: 12px 16px; font-size: 0.85rem; }
  .amount-debit { color: var(--red); }
  .amount-credit { color: var(--green); }
  .category-badge {
    display: inline-block; padding: 2px 10px; border-radius: 999px;
    font-size: 0.75rem; font-weight: 500; background: var(--accent-dim);
    color: var(--accent);
  }
  .account-badge {
    display: inline-block; padding: 2px 8px; border-radius: 999px;
    font-size: 0.7rem; background: var(--bg-secondary); color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  /* Pagination */
  .pagination {
    display: flex; justify-content: center; align-items: center; gap: 8px;
    padding: 16px;
  }
  .pagination button {
    padding: 6px 14px; border-radius: var(--radius-sm); font-size: 0.8rem;
    border: 1px solid var(--border); background: var(--bg-secondary);
    color: var(--text-primary); cursor: pointer;
  }
  .pagination button:disabled { opacity: 0.4; cursor: default; }
  .pagination button.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .pagination span { font-size: 0.8rem; color: var(--text-secondary); }

  /* Active filter chips */
  .filter-chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 4px 12px; border-radius: 999px; font-size: 0.75rem;
    background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(249,115,22,0.3);
  }
  .filter-chip button {
    background: none; border: none; color: var(--accent); cursor: pointer;
    font-size: 0.9rem; line-height: 1; padding: 0; margin-left: 2px;
  }
  .filter-chip button:hover { color: var(--red); }

  /* Sort indicators */
  thead th .sort-arrow { font-size: 0.65rem; margin-left: 4px; color: var(--accent); }

  /* Quick date buttons */
  .quick-dates { display: flex; gap: 6px; align-items: flex-end; }
  .quick-btn {
    padding: 6px 12px; border-radius: var(--radius-sm); font-size: 0.75rem;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-secondary); cursor: pointer; white-space: nowrap;
  }
  .quick-btn:hover { border-color: var(--accent); color: var(--text-primary); }
  .quick-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

  .loading { text-align: center; padding: 60px; color: var(--text-muted); }
  .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid var(--accent); border-top-color: transparent; border-radius: 50%; animation: spin 0.7s linear infinite; margin-left: 10px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 900px) {
    .charts-grid { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>CIBC</span> Finance Dashboard</h1>
    <div class="header-meta" id="meta">Loading...</div>
  </header>

  <div class="summary-grid" id="summary">
    <div class="card"><div class="card-label">Total Spent</div><div class="card-value expense" id="s-spent">--</div></div>
    <div class="card"><div class="card-label">Total Income</div><div class="card-value income" id="s-income">--</div></div>
    <div class="card"><div class="card-label">Transactions</div><div class="card-value neutral" id="s-count">--</div></div>
    <div class="card"><div class="card-label">Top Category</div><div class="card-value neutral" id="s-top-cat">--</div><div class="card-sub" id="s-top-cat-amt"></div></div>
  </div>

  <div class="filter-bar" style="margin-bottom:8px;padding:10px 16px;gap:8px">
    <span style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);align-self:center">Quick:</span>
    <button class="quick-btn" onclick="setQuickDate('7d')">7 Days</button>
    <button class="quick-btn" onclick="setQuickDate('30d')">30 Days</button>
    <button class="quick-btn" onclick="setQuickDate('90d')">90 Days</button>
    <button class="quick-btn" onclick="setQuickDate('6m')">6 Months</button>
    <button class="quick-btn" onclick="setQuickDate('ytd')">YTD</button>
    <button class="quick-btn" onclick="setQuickDate('1y')">1 Year</button>
    <button class="quick-btn" onclick="setQuickDate('all')">All Time</button>
  </div>

  <div class="filter-bar">
    <div class="filter-group">
      <label>Date From</label>
      <input type="date" id="f-date-from">
    </div>
    <div class="filter-group">
      <label>Date To</label>
      <input type="date" id="f-date-to">
    </div>
    <div class="filter-group">
      <label>Category</label>
      <select id="f-category"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Account</label>
      <select id="f-account">
        <option value="">All</option>
        <option value="credit">Credit Card</option>
        <option value="chequing">Chequing</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Type</label>
      <select id="f-type">
        <option value="">All</option>
        <option value="debit">Debits Only</option>
        <option value="credit">Credits Only</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Min $</label>
      <input type="number" id="f-amount-min" placeholder="0" min="0" step="0.01" style="width:90px">
    </div>
    <div class="filter-group">
      <label>Max $</label>
      <input type="number" id="f-amount-max" placeholder="∞" min="0" step="0.01" style="width:90px">
    </div>
    <div class="filter-group" style="flex:1;min-width:160px">
      <label>Search</label>
      <input type="text" id="f-search" placeholder="merchant, category, description...">
    </div>
    <button class="btn" onclick="applyFilters()">Apply</button>
    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
  </div>

  <!-- Active filter chips -->
  <div id="active-filters" style="display:none;margin-bottom:16px;display:flex;flex-wrap:wrap;gap:8px"></div>

  <div class="charts-grid">
    <div class="chart-card">
      <h3>Spending by Category</h3>
      <div class="chart-container"><canvas id="chart-category"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Monthly Spending Trend</h3>
      <div class="chart-container"><canvas id="chart-monthly"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Top Companies</h3>
      <div class="chart-container"><canvas id="chart-companies"></canvas></div>
    </div>
    <div class="chart-card">
      <h3>Credit vs Chequing</h3>
      <div class="chart-container"><canvas id="chart-accounts"></canvas></div>
    </div>
  </div>

  <div class="table-card">
    <div class="table-header">
      <h3>Transactions</h3>
      <span id="table-info" style="font-size:0.8rem;color:var(--text-muted)"></span>
    </div>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('timestamp')" id="th-timestamp">Date</th>
            <th onclick="sortTable('merchant')" id="th-merchant">Merchant</th>
            <th onclick="sortTable('description')" id="th-description">Description</th>
            <th onclick="sortTable('amount')" id="th-amount">Amount</th>
            <th onclick="sortTable('category')" id="th-category">Category</th>
            <th>Account</th>
          </tr>
        </thead>
        <tbody id="txn-body"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<script>
const API = '';
let currentPage = 1;
let perPage = 50;
let sortField = 'timestamp';
let sortDir = 'desc';
let charts = {};

const fmt = (n) => n.toLocaleString('en-CA', {style:'currency',currency:'CAD'});
const fmtShort = (n) => n >= 1000 ? `$${(n/1000).toFixed(1)}k` : fmt(n);

const CATEGORY_COLORS = [
  '#f97316','#3fb950','#58a6ff','#bc8cff','#f85149',
  '#e3b341','#79c0ff','#d2a8ff','#56d364','#ff7b72',
  '#ffa657','#a5d6ff','#d8b4fe','#7ee787','#ffa198',
  '#f0883e','#a371f7','#39d353','#79c0ff','#ff9bce',
  '#4493f8','#db61a2','#2ea043'
];

let activeQuickDate = '';

function getFilterParams() {
  const params = new URLSearchParams();
  const dateFrom = document.getElementById('f-date-from').value;
  const dateTo = document.getElementById('f-date-to').value;
  const cat = document.getElementById('f-category').value;
  const acct = document.getElementById('f-account').value;
  const search = document.getElementById('f-search').value;
  const amtMin = document.getElementById('f-amount-min').value;
  const amtMax = document.getElementById('f-amount-max').value;
  const txnType = document.getElementById('f-type').value;
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);
  if (cat) params.set('category', cat);
  if (acct) params.set('account', acct);
  if (search) params.set('search', search);
  if (amtMin) params.set('amount_min', amtMin);
  if (amtMax) params.set('amount_max', amtMax);
  // txnType is handled client-side since API doesn't have this filter
  return params;
}

function setQuickDate(preset) {
  activeQuickDate = preset;
  const now = new Date();
  let from = new Date();
  document.getElementById('f-date-to').value = now.toISOString().substring(0,10);

  switch(preset) {
    case '7d': from.setDate(now.getDate() - 7); break;
    case '30d': from.setDate(now.getDate() - 30); break;
    case '90d': from.setDate(now.getDate() - 90); break;
    case '6m': from.setMonth(now.getMonth() - 6); break;
    case 'ytd': from = new Date(now.getFullYear(), 0, 1); break;
    case '1y': from.setFullYear(now.getFullYear() - 1); break;
    case 'all': document.getElementById('f-date-from').value = ''; document.getElementById('f-date-to').value = ''; applyFilters(); updateQuickBtns(); return;
  }
  document.getElementById('f-date-from').value = from.toISOString().substring(0,10);
  updateQuickBtns();
  applyFilters();
}

function updateQuickBtns() {
  document.querySelectorAll('.quick-btn').forEach(btn => {
    const preset = btn.getAttribute('onclick')?.match(/'(\w+)'/)?.[1];
    btn.classList.toggle('active', preset === activeQuickDate);
  });
}

function renderActiveFilters() {
  const container = document.getElementById('active-filters');
  const chips = [];
  const dateFrom = document.getElementById('f-date-from').value;
  const dateTo = document.getElementById('f-date-to').value;
  const cat = document.getElementById('f-category').value;
  const acct = document.getElementById('f-account').value;
  const search = document.getElementById('f-search').value;
  const amtMin = document.getElementById('f-amount-min').value;
  const amtMax = document.getElementById('f-amount-max').value;
  const txnType = document.getElementById('f-type').value;

  if (dateFrom) chips.push({label: `From: ${dateFrom}`, clear: () => { document.getElementById('f-date-from').value=''; activeQuickDate=''; }});
  if (dateTo) chips.push({label: `To: ${dateTo}`, clear: () => { document.getElementById('f-date-to').value=''; activeQuickDate=''; }});
  if (cat) chips.push({label: `Category: ${cat}`, clear: () => document.getElementById('f-category').value=''});
  if (acct) chips.push({label: `Account: ${acct}`, clear: () => document.getElementById('f-account').value=''});
  if (txnType) chips.push({label: `Type: ${txnType === 'debit' ? 'Debits' : 'Credits'}`, clear: () => document.getElementById('f-type').value=''});
  if (amtMin) chips.push({label: `Min: $${amtMin}`, clear: () => document.getElementById('f-amount-min').value=''});
  if (amtMax) chips.push({label: `Max: $${amtMax}`, clear: () => document.getElementById('f-amount-max').value=''});
  if (search) chips.push({label: `"${search}"`, clear: () => document.getElementById('f-search').value=''});

  if (chips.length === 0) { container.style.display = 'none'; return; }
  container.style.display = 'flex';
  container.innerHTML = chips.map((c,i) =>
    `<span class="filter-chip">${escHtml(c.label)}<button onclick="clearChip(${i})">×</button></span>`
  ).join('');
  container._chips = chips;
}

function clearChip(index) {
  const container = document.getElementById('active-filters');
  if (container._chips && container._chips[index]) {
    container._chips[index].clear();
    updateQuickBtns();
    applyFilters();
  }
}

function updateSortHeaders() {
  ['timestamp','merchant','description','amount','category'].forEach(f => {
    const th = document.getElementById('th-' + f);
    if (!th) return;
    const base = th.textContent.replace(/[▲▼]/g, '').trim();
    if (f === sortField) {
      th.innerHTML = `${base} <span class="sort-arrow">${sortDir === 'asc' ? '▲' : '▼'}</span>`;
    } else {
      th.textContent = base;
    }
  });
}

async function fetchJSON(url) {
  const res = await fetch(API + url);
  if (!res.ok) throw new Error(`${res.status}`);
  return res.json();
}

async function init() {
  try {
    const cats = await fetchJSON('/bank/categories');
    const sel = document.getElementById('f-category');
    cats.categories.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.name; opt.textContent = `${c.name} (${c.count})`;
      sel.appendChild(opt);
    });

    // Enter key triggers search
    document.getElementById('f-search').addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters(); });
    document.getElementById('f-amount-min').addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters(); });
    document.getElementById('f-amount-max').addEventListener('keydown', e => { if (e.key === 'Enter') applyFilters(); });

    updateSortHeaders();
    await loadAll();
  } catch(e) {
    document.getElementById('meta').textContent = 'Error loading data: ' + e.message;
  }
}

async function loadAll() {
  const fp = getFilterParams();
  const fpStr = fp.toString();
  const qs = fpStr ? `&${fpStr}` : '';

  await Promise.all([
    loadSummaryCards(qs),
    renderCategoryChart(qs),
    renderMonthlyChart(qs),
    renderCompanyChart(qs),
    renderAccountChart(fp),
    loadTransactions(),
  ]);
}

async function loadSummaryCards(qs) {
  const summary = await fetchJSON(`/bank/summary?group_by=category${qs}`);
  const debitCats = summary.groups.filter(g => g.debits > 0);
  const totalSpent = debitCats.reduce((s,g) => s + g.debits, 0);
  const totalCredits = summary.groups.reduce((s,g) => s + g.credits, 0);
  document.getElementById('s-spent').textContent = fmt(totalSpent);
  document.getElementById('s-income').textContent = fmt(totalCredits);
  document.getElementById('s-count').textContent = summary.total_transactions.toLocaleString();
  const meaningful = debitCats.filter(c => c.name !== 'Other' && c.name !== 'Transfer' && c.name !== 'Banking');
  const top = meaningful.length > 0 ? meaningful[0] : debitCats[0];
  if (top) {
    document.getElementById('s-top-cat').textContent = top.name;
    document.getElementById('s-top-cat-amt').textContent = fmt(top.debits);
  } else {
    document.getElementById('s-top-cat').textContent = '--';
    document.getElementById('s-top-cat-amt').textContent = '';
  }
  document.getElementById('meta').textContent = `${summary.total_transactions.toLocaleString()} transactions loaded`;
}

async function renderCategoryChart(qs) {
  const summary = await fetchJSON(`/bank/summary?group_by=category${qs}`);
  const filtered = summary.groups.filter(g => g.debits > 0 && g.name !== 'Other' && g.name !== 'Transfer').slice(0, 12);
  const ctx = document.getElementById('chart-category').getContext('2d');
  if (charts.category) charts.category.destroy();
  charts.category = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: filtered.map(g => g.name),
      datasets: [{
        data: filtered.map(g => g.debits),
        backgroundColor: CATEGORY_COLORS.slice(0, filtered.length),
        borderWidth: 0,
        hoverOffset: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: { position: 'right', labels: { color: '#8b949e', font: { size: 11 }, padding: 8, boxWidth: 12, boxHeight: 12 } },
        tooltip: { callbacks: { label: (c) => `${c.label}: ${fmt(c.raw)}` } },
      }
    }
  });
}

async function renderMonthlyChart(qs) {
  const data = await fetchJSON(`/bank/summary?group_by=month${qs}`);
  const months = data.groups.sort((a,b) => a.name.localeCompare(b.name)).slice(-18);
  const ctx = document.getElementById('chart-monthly').getContext('2d');
  if (charts.monthly) charts.monthly.destroy();
  charts.monthly = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months.map(m => m.name),
      datasets: [{
        label: 'Spending',
        data: months.map(m => m.debits),
        borderColor: '#f97316',
        backgroundColor: 'rgba(249,115,22,0.1)',
        fill: true, tension: 0.3, pointRadius: 3, pointHoverRadius: 6,
        borderWidth: 2,
      }, {
        label: 'Income',
        data: months.map(m => m.credits),
        borderColor: '#3fb950',
        backgroundColor: 'rgba(63,185,80,0.1)',
        fill: true, tension: 0.3, pointRadius: 3, pointHoverRadius: 6,
        borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: '#6e7681', maxRotation: 45 }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#6e7681', callback: v => fmtShort(v) }, grid: { color: '#21262d' } },
      },
      plugins: {
        legend: { labels: { color: '#8b949e', boxWidth: 12 } },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${fmt(c.raw)}` } },
      }
    }
  });
}

async function renderCompanyChart(qs) {
  const data = await fetchJSON(`/bank/summary?group_by=company${qs}`);
  const top = data.groups.filter(g => g.debits > 0 && g.name !== 'Other').slice(0, 15);
  const ctx = document.getElementById('chart-companies').getContext('2d');
  if (charts.companies) charts.companies.destroy();
  charts.companies = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top.map(c => c.name),
      datasets: [{
        data: top.map(c => c.debits),
        backgroundColor: CATEGORY_COLORS.slice(0, top.length),
        borderWidth: 0, borderRadius: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: { ticks: { color: '#6e7681', callback: v => fmtShort(v) }, grid: { color: '#21262d' } },
        y: { ticks: { color: '#8b949e', font: { size: 11 } }, grid: { display: false } },
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => fmt(c.raw) } },
      }
    }
  });
}

async function renderAccountChart(fp) {
  const creditP = new URLSearchParams(fp);
  creditP.set('account', 'credit');
  creditP.set('per_page', '1');
  const cheqP = new URLSearchParams(fp);
  cheqP.set('account', 'chequing');
  cheqP.set('per_page', '1');
  const [credit, chequing] = await Promise.all([
    fetchJSON(`/bank/transactions?${creditP}`),
    fetchJSON(`/bank/transactions?${cheqP}`),
  ]);
  const ctx = document.getElementById('chart-accounts').getContext('2d');
  if (charts.accounts) charts.accounts.destroy();
  charts.accounts = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Credit Card', 'Chequing'],
      datasets: [{
        data: [credit.total, chequing.total],
        backgroundColor: ['#f97316', '#58a6ff'],
        borderWidth: 0, hoverOffset: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: { position: 'right', labels: { color: '#8b949e', font: { size: 12 }, padding: 12, boxWidth: 14 } },
        tooltip: { callbacks: { label: c => `${c.label}: ${c.raw.toLocaleString()} txns` } },
      }
    }
  });
}

async function loadTransactions() {
  const params = getFilterParams();
  params.set('page', currentPage);
  params.set('per_page', perPage);
  if (sortField) { params.set('sort', sortField); params.set('sort_dir', sortDir); }

  const data = await fetchJSON(`/bank/transactions?${params}`);

  // Client-side type filter (debit/credit)
  const txnType = document.getElementById('f-type').value;
  if (txnType) {
    data.transactions = data.transactions.filter(t => {
      const isDebit = t.metadata?.is_debit !== false;
      return txnType === 'debit' ? isDebit : !isDebit;
    });
  }

  renderTable(data);
  renderPagination(data);
  updateSortHeaders();
  document.getElementById('table-info').textContent = `Showing ${data.transactions.length} of ${data.total.toLocaleString()}`;
}

function renderTable(data) {
  const body = document.getElementById('txn-body');
  if (data.transactions.length === 0) {
    body.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">No transactions found</td></tr>';
    return;
  }

  body.innerHTML = data.transactions.map(t => {
    const isDebit = t.metadata?.is_debit !== false;
    const amtClass = isDebit ? 'amount-debit' : 'amount-credit';
    const amtPrefix = isDebit ? '-' : '+';
    const desc = (t.description || '').length > 60 ? t.description.substring(0,57) + '...' : (t.description || '');
    const acctType = t.metadata?.account_type || 'unknown';
    return `<tr>
      <td style="white-space:nowrap">${t.timestamp.substring(0,10)}</td>
      <td style="font-weight:500">${escHtml(t.merchant)}</td>
      <td style="color:var(--text-secondary);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(t.description || '')}">${escHtml(desc)}</td>
      <td class="${amtClass}" style="font-weight:600;white-space:nowrap">${amtPrefix}${fmt(t.amount)}</td>
      <td><span class="category-badge">${escHtml(t.metadata?.spending_category || t.category)}</span></td>
      <td><span class="account-badge">${acctType}</span></td>
    </tr>`;
  }).join('');
}

function renderPagination(data) {
  const el = document.getElementById('pagination');
  if (data.pages <= 1) { el.innerHTML = ''; return; }

  let html = `<button ${data.page <= 1 ? 'disabled' : ''} onclick="goPage(${data.page-1})">Prev</button>`;
  const start = Math.max(1, data.page - 3);
  const end = Math.min(data.pages, data.page + 3);
  for (let i = start; i <= end; i++) {
    html += `<button class="${i===data.page?'active':''}" onclick="goPage(${i})">${i}</button>`;
  }
  html += `<button ${data.page >= data.pages ? 'disabled' : ''} onclick="goPage(${data.page+1})">Next</button>`;
  html += `<span>of ${data.pages} pages</span>`;
  el.innerHTML = html;
}

function goPage(p) { currentPage = p; loadTransactions(); }

function applyFilters() {
  currentPage = 1;
  renderActiveFilters();
  loadAll();
}

function resetFilters() {
  document.getElementById('f-date-from').value = '';
  document.getElementById('f-date-to').value = '';
  document.getElementById('f-category').value = '';
  document.getElementById('f-account').value = '';
  document.getElementById('f-search').value = '';
  document.getElementById('f-amount-min').value = '';
  document.getElementById('f-amount-max').value = '';
  document.getElementById('f-type').value = '';
  activeQuickDate = '';
  updateQuickBtns();
  currentPage = 1;
  renderActiveFilters();
  loadAll();
}

function sortTable(field) {
  if (sortField === field) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  else { sortField = field; sortDir = 'desc'; }
  updateSortHeaders();
  loadTransactions();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

init();
</script>
</body>
</html>
