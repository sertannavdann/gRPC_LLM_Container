FROM nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

# System dependencies
RUN apt-get update && apt-get install -y \
    python3 python3-pip curl \
    && rm -rf /var/lib/apt/lists/* \
    && GRPC_HEALTH_PROBE_VERSION=v0.4.25 \
    && curl -fsSL https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 -o /usr/local/bin/grpc_health_probe \
    && chmod +x /usr/local/bin/grpc_health_probe

WORKDIR /app

# Python dependencies for AirLLM + gRPC
COPY llm_service/requirements-airllm.txt .
RUN pip3 install --upgrade pip && \
    pip3 install --default-timeout=100 --no-cache-dir -r requirements-airllm.txt

# Generate proto stubs
COPY shared/proto/llm.proto ./proto/
RUN pip3 install grpcio-tools && \
    python3 -m grpc_tools.protoc \
    -I ./proto \
    --python_out=. \
    --grpc_python_out=. \
    proto/llm.proto && \
    rm -rf ./proto

# Copy service files
COPY llm_service/airllm_service.py .
COPY llm_service/model_registry.py .

EXPOSE 50051
CMD ["python3", "airllm_service.py"]
